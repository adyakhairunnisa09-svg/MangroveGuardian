<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mangrove Guardian - EVI Karangantu 2024</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <!-- Leaflet JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <!-- Leaflet Draw -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

  <style>
    /* VARIABLES */
    :root{
      --mg-green:#0a5c36;
      --mg-green-light:#1a7d4e;
      --mg-green-dark:#064527;
      --panel:rgba(255,255,255,0.95);
      --muted:#51606a;
      --navbar-height: 60px; 
    }
    
    *{box-sizing:border-box; margin:0; padding:0;}
    
    html,body{height:100%; margin:0; font-family:'Segoe UI', system-ui, sans-serif; color:#15302a;}
    body{background:#f8f9fa;}
    #map{flex:1; z-index:1;}

    .topbar{
      height: var(--navbar-height);
      padding:0 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:var(--mg-green);
      color:#fff;
      position:sticky;
      top:0;
      z-index:1500;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-bottom: 1px solid var(--mg-green-dark);
    }
    
    .brand{
      font-weight:600;
      font-size:20px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    
    .nav-right-container{display:flex; align-items:center; gap:25px;}
    .nav-menu{display:flex; gap:25px}
    .nav-menu a{
      color:#fff;
      text-decoration:none;
      font-size:14px;
      font-weight:500;
      padding:8px 0;
      transition:opacity 0.2s;
    }
    .nav-menu a:hover{opacity:0.8;}
    .lang-switch{
      font-size:13px;
      cursor:pointer;
      background:rgba(255,255,255,0.15);
      padding:6px 12px;
      border-radius:4px;
      font-weight:500;
    }

    .chat-box-container{
      position:fixed;
      bottom:20px;
      right:20px;
      z-index:1600;
      width:350px;
      background:var(--panel);
      border-radius:8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      border:1px solid #e1e5e9;
      display:flex;
      flex-direction:column;
      max-height:500px;
    }
    
    .chat-header{
      background: var(--mg-green);
      color: #fff;
      padding: 12px 16px;
      font-weight: 600;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-radius:8px 8px 0 0;
    }
    
    .chat-content{
      padding: 16px;
      flex:1;
      overflow-y: auto;
      display:flex;
      flex-direction:column;
      gap:12px;
      max-height:300px;
    }
    
    .chat-input-row{
      display:flex;
      gap:8px;
      padding:12px 16px;
      border-top:1px solid #e1e5e9;
      background:#f8f9fa;
    }
    
    .chat-input-row input{
      flex:1;
      padding:10px 12px;
      border-radius:6px;
      border:1px solid #ddd;
      outline:none;
      font-size:14px;
      background:#fff;
    }
    
    .chat-input-row button{
      background:var(--mg-green);
      border:0;
      color:#fff;
      padding:10px 16px;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
    }

    .chat-message{
      padding:10px 14px;
      border-radius:8px;
      max-width:85%;
      font-size:14px;
      line-height:1.4;
    }
    
    .chat-user{
      background:#e3f2fd;
      align-self:flex-end;
      border-bottom-right-radius:2px;
    }
    
    .chat-bot{
      background:#f5f5f5;
      align-self:flex-start;
      border-bottom-left-radius:2px;
    }

    .app{
      height:calc(100vh - var(--navbar-height));
      position:relative;
      display:flex;
    }

    .search-row-container{
      position:absolute;
      top:20px;
      left:50%;
      transform:translateX(-50%);
      z-index:1300;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      width:90%;
      max-width:700px;
    }
    
    .search-row{
      display:flex;
      align-items:center;
      gap:8px;
      width:100%;
    }
    
    .search-box{
      display:flex;
      align-items:center;
      background:var(--panel);
      padding:8px 16px;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      width:100%;
      border:1px solid #e1e5e9;
      flex:1;
    }
    
    .search-box input{
      border:0;
      outline:none;
      padding:8px;
      font-size:14px;
      background:transparent;
      flex:1;
    }
    
    .search-box button{
      background:var(--mg-green);
      border:0;
      color:#fff;
      padding:8px 16px;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
    }
    
    .action-btn{
      background:var(--mg-green);
      color:#fff;
      border-radius:8px;
      padding:10px 16px;
      border:none;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
      white-space:nowrap;
    }
    
    .mapFlipBtn{
      background:var(--mg-green);
      border:none;
      padding:10px;
      border-radius:6px;
      color:white;
      cursor:pointer;
      font-size:16px;
    }

    .stats-toggle-btn {
      background:var(--mg-green);
      border:none;
      padding:10px 14px;
      border-radius:6px;
      color:white;
      cursor:pointer;
      font-size:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
      transition:all 0.3s ease;
      white-space: nowrap;
    }

    .stats-toggle-btn:hover {
      background:var(--mg-green-light);
      transform: translateY(-1px);
    }

    .vtoolbar{
      position:absolute;
      left:20px;
      top:120px;
      z-index:1300;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:8px;
      border-radius:8px;
      background:transparent;
    }
    
    .vt-btn{
      width:44px;
      height:44px;
      border-radius:6px;
      background:var(--panel);
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid #e1e5e9;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
      cursor:pointer;
      font-size:16px;
      transition:all 0.2s;
    }
    
    .vt-btn:hover{
      background:#f8f9fa;
    }

    .right-panel{
      position:absolute;
      right:20px;
      top:20px;
      width:320px;
      z-index:1300;
      background:var(--panel);
      border-radius:8px;
      box-shadow:0 4px 20px rgba(0,0,0,0.15);
      border:1px solid #e1e5e9;
      max-height:calc(100vh - 100px);
      overflow-y:auto;
    }
    
    .panel-inner{
      padding:16px;
    }
    
    .panel-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:16px;
      padding-bottom:12px;
      border-bottom:1px solid #e1e5e9;
    }
    
    .panel-header h3{
      margin:0;
      color:var(--mg-green);
      font-size:16px;
      font-weight:600;
    }

    .switch-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 0;
      border-bottom:1px solid #f0f0f0;
    }
    
    .switch-label{
      font-size:14px;
      color:#333;
    }
    
    .switch{
      position:relative;
      width:44px;
      height:24px;
      border-radius:12px;
      background:#ddd;
      cursor:pointer;
    }
    
    .switch .knob{
      position:absolute;
      top:2px;
      left:2px;
      width:20px;
      height:20px;
      border-radius:50%;
      background:white;
      box-shadow:0 1px 3px rgba(0,0,0,0.2);
      transition:left 0.2s;
    }
    
    .switch.on{
      background:var(--mg-green);
    }
    
    .switch.on .knob{
      left:22px;
    }

    .basemap-toggle{
      position:absolute;
      right:20px;
      top:70px;
      z-index:1350;
    }
    
    .basemap-card{
      width:250px;
      background:var(--panel);
      border-radius:8px;
      padding:12px;
      box-shadow:0 4px 20px rgba(0,0,0,0.15);
      border:1px solid #e1e5e9;
    }
    
    .basemap-card.hidden{
      display:none;
    }
    
    .basemap-item{
      padding:10px;
      border-radius:6px;
      margin-bottom:6px;
      cursor:pointer;
      font-size:14px;
      border:1px solid transparent;
    }
    
    .basemap-item:hover{
      background:#f8f9fa;
    }
    
    .basemap-item.active{
      background:#e8f5e8;
      border-color:var(--mg-green);
    }

    .scale-box{
      position:absolute;
      left:20px;
      bottom:20px;
      background:var(--panel);
      padding:8px 12px;
      border-radius:6px;
      font-size:12px;
      border:1px solid #e1e5e9;
      z-index:1300;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }

    .class-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 0;
      border-bottom:1px solid #f0f0f0;
    }
    
    .class-color{
      width:16px;
      height:16px;
      border-radius:3px;
    }
    
    .class-label{
      flex:1;
      font-size:13px;
    }

    .file-upload{
      margin-top:16px;
      padding:12px;
      border:2px dashed #ddd;
      border-radius:6px;
      text-align:center;
      cursor:pointer;
      transition:border-color 0.2s;
    }
    
    .file-upload:hover{
      border-color:var(--mg-green);
    }
    
    .file-hint{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      text-align:center;
    }

    .vt-btn.active-draw{
      background:var(--mg-green);
      color:#fff;
    }
    
    .vt-btn.delete-active{
      background:#dc3545;
      color:#fff;
    }

    @media (max-width:768px){
      .nav-menu{display:none}
      .search-row{flex-wrap:wrap;}
      .right-panel{width:95%; right:2.5%;}
      .chat-box-container{width:95%; right:2.5%;}
      .stats-panel{width:95%; left:2.5%;}
      .stats-toggle-btn{display:none;}
    }

    .analysis-section {
      margin: 16px 0;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
    }
    
    .pulau-selector {
      margin-bottom: 12px;
    }
    
    .pulau-selector select {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    
    .data-display {
      background: white;
      padding: 12px;
      border-radius: 4px;
      margin-top: 8px;
    }
    
    .data-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 13px;
    }
    
    .data-value {
      font-weight: 600;
      color: var(--mg-green);
    }

    .custom-tooltip {
      background: rgba(255, 255, 255, 0.95) !important;
      border: 1px solid #0a5c36 !important;
      border-radius: 4px !important;
      padding: 4px 8px !important;
      font-size: 12px !important;
      font-weight: 500 !important;
    }

    .legend {
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    
    .legend h4 {
      margin: 0 0 8px 0;
    }

    .stats-panel {
      position: absolute;
      left: 80px;
      top: 120px;
      z-index: 1300;
      background: var(--panel);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      border: 1px solid #e1e5e9;
      width: 300px;
      max-height: 75vh;
      overflow-y: auto;
      transition: all 0.3s ease;
    }

    .stats-header {
      font-weight: 600;
      color: var(--mg-green);
      margin-bottom: 12px;
      font-size: 16px;
      border-bottom: 2px solid var(--mg-green);
      padding-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stats-close {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: var(--muted);
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stats-close:hover {
      color: var(--mg-green);
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
      padding: 6px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .stat-item:last-child {
      border-bottom: none;
    }

    .stat-value {
      font-weight: 600;
      color: var(--mg-green);
    }

    .chart-container {
      margin-top: 15px;
      height: 200px;
      position: relative;
    }

    .download-btn {
      background: var(--mg-green);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin-top: 15px;
      width: 100%;
      transition: background 0.3s ease;
    }

    .download-btn:hover {
      background: var(--mg-green-light);
    }

    .collapsible {
      margin-top: 10px;
    }

    .collapsible-header {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 13px;
      color: var(--mg-green);
    }

    .collapsible-content {
      padding: 10px;
      background: white;
      border-radius: 0 0 6px 6px;
      margin-top: 2px;
    }

    .collapsible.hidden .collapsible-content {
      display: none;
    }

    /* Progress Bar untuk Loading */
    .progress-bar {
      width: 100%;
      height: 4px;
      background: #f0f0f0;
      border-radius: 2px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: var(--mg-green);
      transition: width 0.3s ease;
    }

    /* Filter Controls */
    .filter-controls {
      margin: 15px 0;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
    }

    .filter-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--mg-green);
    }

    .filter-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .filter-btn {
      padding: 6px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .filter-btn.active {
      background: var(--mg-green);
      color: white;
      border-color: var(--mg-green);
    }

    .filter-btn:hover {
      background: #e9ecef;
    }

    .filter-btn.active:hover {
      background: var(--mg-green-light);
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="topbar">
    <div class="brand">
      <span>üåø MangroveGuardian - EVI Karangantu 2024</span>
    </div>
    <div class="nav-right-container">
      <div class="nav-menu" id="navMenu">
        <a href="indeks.html" data-key="home">Beranda</a>
        <a href="indeks.html" data-key="about">Tentang</a>
        <a href="indeks.html" data-key="team">Tim</a>
        <a href="indeks.html" data-key="contact">Kontak</a>
      </div>
      <div class="lang-switch" id="langSwitch">ID / EN</div>
    </div>
  </div>

  <!-- Chat Box -->
  <div class="chat-box-container" id="chatBoxContainer">
    <div class="chat-header" id="chatHeader">
      <span>üí¨ Asisten Mangrove</span>
      <span>‚àí</span>
    </div>
    <div class="chat-content" id="chatContent">
      <div class="chat-message chat-bot">Halo! Saya asisten virtual Mangrove Guardian. Data EVI Karangantu 2024 memiliki 6 poligon dengan total luasan 41.70 ha.</div>
    </div>
    <div class="chat-input-row">
      <input type="text" id="chatInput" placeholder="Ketik pertanyaan Anda..." />
      <button id="sendChat">Kirim</button>
    </div>
  </div>

  <!-- Main App -->
  <div class="app">
    <div id="map"></div>

    <!-- Search Bar dengan Tombol Statistik di Kiri -->
    <div class="search-row-container">
      <div class="search-row">
        <!-- Tombol Statistik di sebelah kiri search box -->
        <button class="stats-toggle-btn" id="statsToggle" title="Toggle Panel Statistik">
          üìä Statistik
        </button>

        <!-- Search Box di tengah -->
        <div class="search-box">
          <input id="searchInput" placeholder="Cari lokasi atau koordinat (contoh: -6.029,106.165)..." />
          <button id="doSearch">Cari</button>
        </div>

        <!-- Tombol-tombol lainnya di sebelah kanan -->
        <button class="action-btn" id="addPointBtn">+ Titik Baru</button>
        <button id="basemapFlipBtn" class="mapFlipBtn" title="Peta Dasar">üó∫Ô∏è</button>
        <button id="togglePanelBtn" class="mapFlipBtn" title="Panel Layer">‚ò∞</button>
      </div>
    </div>

    <!-- Statistics Panel -->
    <div class="stats-panel" id="statsPanel">
      <div class="stats-header">
        <span>üìä Statistik EVI Karangantu 2024</span>
        <button class="stats-close" id="statsClose" title="Tutup">‚úï</button>
      </div>
      
      <div class="progress-bar">
        <div class="progress-fill" id="dataProgress" style="width: 100%"></div>
      </div>
      
      <div class="stat-item">
        <span>Total Luasan:</span>
        <span class="stat-value" id="totalLuas">41.70 ha</span>
      </div>
      <div class="stat-item">
        <span>Jumlah Poligon:</span>
        <span class="stat-value" id="jumlahPoligon">6</span>
      </div>
      <div class="stat-item">
        <span>Kerapatan Rata-rata:</span>
        <span class="stat-value" id="kerapatanRata">3.5</span>
      </div>
      <div class="stat-item">
        <span>Luasan Tertinggi:</span>
        <span class="stat-value" id="luasMax">13.24 ha</span>
      </div>
      <div class="stat-item">
        <span>Luasan Terendah:</span>
        <span class="stat-value" id="luasMin">2.25 ha</span>
      </div>

      <!-- Filter Controls -->
      <div class="filter-controls">
        <div class="filter-title">Filter Kerapatan:</div>
        <div class="filter-buttons">
          <button class="filter-btn active" data-density="all">Semua</button>
          <button class="filter-btn" data-density="1">Sangat Rendah</button>
          <button class="filter-btn" data-density="2">Rendah</button>
          <button class="filter-btn" data-density="3">Sedang-Rendah</button>
          <button class="filter-btn" data-density="4">Sedang</button>
          <button class="filter-btn" data-density="5">Tinggi</button>
          <button class="filter-btn" data-density="6">Sangat Tinggi</button>
        </div>
      </div>

      <!-- Collapsible Chart Section -->
      <div class="collapsible" id="chartCollapsible">
        <div class="collapsible-header" id="chartHeader">
          <span>üìà Grafik Distribusi</span>
          <span>‚ñº</span>
        </div>
        <div class="collapsible-content">
          <div class="chart-container">
            <canvas id="densityChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Collapsible Detail Section -->
      <div class="collapsible" id="detailCollapsible">
        <div class="collapsible-header" id="detailHeader">
          <span>üîç Detail Kerapatan</span>
          <span>‚ñº</span>
        </div>
        <div class="collapsible-content">
          <div class="stat-item">
            <span>Sangat Rendah (1):</span>
            <span class="stat-value" id="detailSangatRendah">1 poligon</span>
          </div>
          <div class="stat-item">
            <span>Rendah (2):</span>
            <span class="stat-value" id="detailRendah">1 poligon</span>
          </div>
          <div class="stat-item">
            <span>Sedang-Rendah (3):</span>
            <span class="stat-value" id="detailSedangRendah">1 poligon</span>
          </div>
          <div class="stat-item">
            <span>Sedang (4):</span>
            <span class="stat-value" id="detailSedang">1 poligon</span>
          </div>
          <div class="stat-item">
            <span>Tinggi (5):</span>
            <span class="stat-value" id="detailTinggi">1 poligon</span>
          </div>
          <div class="stat-item">
            <span>Sangat Tinggi (6):</span>
            <span class="stat-value" id="detailSangatTinggi">1 poligon</span>
          </div>
        </div>
      </div>

      <button class="download-btn" id="downloadData">
        üì• Download Data GeoJSON
      </button>

      <button class="download-btn" id="screenshot" style="background: #6c757d; margin-top: 8px;">
        üì∑ Screenshot Peta
      </button>
    </div>

    <!-- Toolbar -->
    <div class="vtoolbar">
      <div class="vt-btn" id="zoomIn" title="Zoom In">+</div>
      <div class="vt-btn" id="zoomOut" title="Zoom Out">‚àí</div>
      <div class="vt-btn" id="measureBtn" title="Ukur Jarak">üìè</div>
      <div style="border-top:1px solid #eee; margin:6px 0"></div>
      <div class="vt-btn" id="drawPt" title="Titik">‚Ä¢</div>
      <div class="vt-btn" id="drawPoly" title="Poligon">‚ñ≥</div>
      <div class="vt-btn" id="drawRect" title="Persegi">‚ñ°</div>
      <div style="border-top:1px solid #eee; margin:6px 0"></div>
      <div class="vt-btn" id="deleteBtn" title="Hapus">üóëÔ∏è</div>
      <div class="vt-btn" id="printBtn" title="Cetak">üñ®Ô∏è</div>
    </div>

    <!-- Scale -->
    <div class="scale-box" id="scaleBox">Skala: 1:100,000</div>
    <div class="scale-box" id="measureBox" style="left:120px; display:none; background:#fff3cd; color:#856404;"></div>

    <!-- Right Panel -->
    <div class="right-panel" id="rightPanel">
      <div class="panel-inner">
        <div class="panel-header">
          <h3>Layer & Pengaturan</h3>
          <button id="closePanel" class="vt-btn" style="width:auto; padding:6px 10px;">‚úï</button>
        </div>

        <!-- Analisis Vegetasi Section -->
        <div class="analysis-section">
          <div style="font-weight:600; color:var(--mg-green); margin-bottom:12px;">üìä Data EVI Karangantu 2024</div>
          
          <div class="pulau-selector">
            <label for="pulauSelect">Pilih Lokasi:</label>
            <select id="pulauSelect">
              <option value="karangantu" selected>Karangantu</option>
            </select>
          </div>

          <div class="pulau-selector">
            <label for="tahunSelect">Pilih Tahun:</label>
            <select id="tahunSelect">
              <option value="2024" selected>2024</option>
            </select>
          </div>

          <div class="data-display">
            <div class="data-item">
              <span>Vegetasi Sangat Rendah:</span>
              <span class="data-value" id="dataSangatRendah">1 poligon</span>
            </div>
            <div class="data-item">
              <span>Vegetasi Rendah:</span>
              <span class="data-value" id="dataRendah">1 poligon</span>
            </div>
            <div class="data-item">
              <span>Vegetasi Sedang-Rendah:</span>
              <span class="data-value" id="dataSedangRendah">1 poligon</span>
            </div>
            <div class="data-item">
              <span>Vegetasi Sedang:</span>
              <span class="data-value" id="dataSedang">1 poligon</span>
            </div>
            <div class="data-item">
              <span>Vegetasi Tinggi:</span>
              <span class="data-value" id="dataTinggi">1 poligon</span>
            </div>
            <div class="data-item">
              <span>Vegetasi Sangat Tinggi:</span>
              <span class="data-value" id="dataSangatTinggi">1 poligon</span>
            </div>
            <div class="data-item">
              <span>EVI Rata-rata:</span>
              <span class="data-value" id="dataEVI">0.58</span>
            </div>
          </div>
        </div>

        <div class="switch-row">
          <div class="switch-label">Layer EVI</div>
          <div class="switch on" id="rasterSwitch"><div class="knob"></div></div>
        </div>

        <div style="margin:16px 0;">
          <div style="font-weight:600; color:var(--mg-green); margin-bottom:12px;">Kelas Kerapatan EVI</div>
          <div id="classesList"></div>
        </div>

        <hr style="margin:16px 0; border:none; border-top:1px solid #e1e5e9;">

        <div style="font-weight:600; color:var(--mg-green); margin-bottom:12px;">Ekspor Data</div>
        <div class="file-upload" id="fileUploadArea">
          <div>üìÅ Upload File GeoJSON</div>
          <input type="file" id="fileInput" accept=".json,.geojson" style="display:none" />
        </div>
        <div class="file-hint">Format yang didukung: GeoJSON, JSON</div>

        <button class="download-btn" id="exportReport">
          üìÑ Export Laporan PDF
        </button>
      </div>
    </div>

    <!-- Basemap Panel -->
    <div class="basemap-toggle">
      <div class="basemap-card hidden" id="basemapCard">
        <div style="font-weight:600; margin-bottom:12px;">Peta Dasar</div>
        <div class="basemap-item active" data-basemap="osm">OpenStreetMap</div>
        <div class="basemap-item" data-basemap="satellite">Satelit</div>
        <div class="basemap-item" data-basemap="terrain">Topografi</div>
      </div>
    </div>
  </div>

  <script>
    // ==================== INISIALISASI PETA ====================
    const map = L.map('map').setView([-6.029, 106.165], 14);

    // Layer Dasar
    const basemaps = {
      'osm': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }),
      'satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '¬© Esri'
      }),
      'terrain': L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/terrain/{z}/{x}/{y}.jpg', {
        attribution: '¬© Stamen Design'
      })
    };

    let currentBasemap = 'satellite';
    basemaps[currentBasemap].addTo(map);

    // ==================== DATA GEOJSON EVI KARANGANTU 2024 ====================
    const eviKarangantu2024 = {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "id": 1,
          "geometry": {
            "type": "MultiPolygon",
            "coordinates": [[[[106.16502781164344,-6.0285207533662124],[106.16475677635965,-6.0285213328124447],[106.16475909154538,-6.0296066644082069],[106.1650301273676,-6.0296060848569111],[106.16502954839676,-6.0293347519883547],[106.16530058405783,-6.0293341723285607],[106.16530116316329,-6.0296055051708457],[106.16584323467505,-6.0296043453944037],[106.16584265530034,-6.0293330126046811],[106.16557161969237,-6.0293335925340026],[106.16557046129185,-6.0287909268937856],[106.16502839053467,-6.0287920862430386],[106.16502781164344,-6.0285207533662124]]],[[[106.17126161583472,-6.0285073889131144],[106.17126103387436,-6.0282360566393827],[106.17098999933702,-6.0282366391583491],[106.17099058116276,-6.0285079714584864],[106.17126161583472,-6.0285073889131144]]],[[[106.16827849161777,-6.0276997918013979],[106.16800745705653,-6.0277003727855609],[106.16800803734857,-6.0279717053812805],[106.16773700262618,-6.0279722862570502],[106.16773758281023,-6.0282436188763349],[106.16800861766721,-6.0282430379742333],[106.16827965249762,-6.0282424569373934],[106.16828023297744,-6.0285137895012566],[106.16855126791583,-6.0285132083033313],[106.16855010671357,-6.0279705432255444],[106.16827907204437,-6.0279711243707794],[106.16827849161777,-6.0276997918013979]]],[[[106.17044676714907,-6.0276951390779328],[106.16990469842604,-6.0276963030671586],[106.16990527966016,-6.0279676354783787],[106.16990586092095,-6.0282389678868311],[106.17044793018229,-6.0282378037920665],[106.17044676714907,-6.0276951390779328]]],[[[106.16394193544971,-6.0277090713807402],[106.16394135720292,-6.0274377383878859],[106.16367032235142,-6.0274383171901684],[106.16367090046363,-6.0277096502092649],[106.16394193544971,-6.0277090713807402]]],[[[106.16827849161777,-6.0276997918013979],[106.16854952615236,-6.027699210682508],[106.16909159514172,-6.0276980480405484],[106.16936262959646,-6.0276974665174778],[106.16936204865816,-6.0274261340507298],[106.1688199799912,-6.0274272969094209],[106.16854894561779,-6.0274278781366872],[106.16827791121774,-6.027428459229232],[106.16827849161777,-6.0276997918013979]]],[[[106.17044676714907,-6.0276951390779328],[106.17098883576544,-6.0276939745498028],[106.17153090427519,-6.027692809482768],[106.17180193849001,-6.0276922267471615],[106.17180135634051,-6.0274208945179559],[106.17044618567247,-6.0274238067166985],[106.17044676714907,-6.0276951390779328]]],[[[106.17342756026146,-6.0274173954337096],[106.17342814321839,-6.0276887275042759],[106.17342872620205,-6.0279600595720586],[106.1742418286093,-6.0279583080524191],[106.17424124522188,-6.0276869760640386],[106.17369917724628,-6.0276881438255892],[106.17369859415477,-6.0274168117814826],[106.17342756026146,-6.0274173954337096]]],[[[106.16583802125861,-6.027162350188016],[106.1658386004209,-6.0274336829996953],[106.16610963506018,-6.0274331031196384],[106.16610905576333,-6.027161770334251],[106.16583802125861,-6.027162350188016]]],[[[106.16827791121774,-6.027428459229232],[106.16827733084433,-6.0271571266543829],[106.16800629655226,-6.027157707585868],[106.1680068767911,-6.0274290401870561],[106.16827791121774,-6.027428459229232]]],[[[106.17017515145886,-6.0274243887522871],[106.17017457014346,-6.0271530563619802],[106.16963250190543,-6.0271542199762393],[106.16963308295168,-6.0274255524193014],[106.17017515145886,-6.0274243887522871]]],[[[106.1747827294607,-6.0274144758253838],[106.17478214585765,-6.0271431438844987],[106.17451111220586,-6.0271437280491167],[106.17451169567435,-6.0274150600164873],[106.1747827294607,-6.0274144758253838]]],[[[106.1761373137152,-6.027140221040713],[106.17586628019724,-6.0271408058788953],[106.17586686433856,-6.027412137713779],[106.17532479695316,-6.0274133070390192],[106.17505376322032,-6.0274138914995605],[106.17505434698474,-6.0276852234112699],[106.17640951605411,-6.0276822996288217],[106.17640893161683,-6.0274109678496606],[106.17613789799108,-6.0274115528490784],[106.1761373137152,-6.027140221040713]]],[[[106.16773526223359,-6.0271582883826387],[106.16773468215591,-6.0268869557523344],[106.16746364794523,-6.0268875363880623],[106.16746422788835,-6.0271588690446949],[106.16773526223359,-6.0271582883826387]]],[[[106.17342756026146,-6.0274173954337096],[106.17342697733126,-6.0271460633604583],[106.17315594354578,-6.0271466468515102],[106.17315536077685,-6.0268753147490184],[106.17288432709921,-6.0268758980789094],[106.17288490973355,-6.0271472302078486],[106.17261387589467,-6.0271478134294734],[106.17261445842121,-6.0274191455820709],[106.172343424421,-6.0274197286954188],[106.17207239039409,-6.0274203116740477],[106.17207297267815,-6.0276916438768282],[106.17261504097438,-6.0276904777319844],[106.17261562355432,-6.0279618098791135],[106.17315769201286,-6.0279606431424755],[106.17315710916378,-6.0276893110482384],[106.17315652634143,-6.0274179789512159],[106.17342756026146,-6.0274173954337096]]],[[[106.17369859415477,-6.0274168117814826],[106.17396962802137,-6.0274162279945376],[106.17396904482202,-6.0271448959742147],[106.17424007852735,-6.027144312079022],[106.17423949522015,-6.0268729800823877],[106.17396846164942,-6.0268735639511064],[106.17369742805195,-6.0268741476851178],[106.17369859415477,-6.0274168117814826]]],[[[106.1631276747523,-6.0271681413163289],[106.16312709696221,-6.0268968082393028],[106.16339813159759,-6.026896229758921],[106.16339755369943,-6.0266248967053739],[106.16312651919861,-6.026625475159527],[106.1628554846713,-6.0266260534789762],[106.16285606230034,-6.0268973865849755],[106.16231399289718,-6.02689854287219],[106.16231457028358,-6.0271698760278669],[106.1631276747523,-6.0271681413163289]]],[[[106.16664996564076,-6.026617944748673],[106.1666505451536,-6.0268892774869975],[106.16692157944406,-6.0268886972553943],[106.1669227388186,-6.0274313626711438],[106.16665170425902,-6.0274319429553627],[106.1666522838516,-6.0277032756854707],[106.16719435321333,-6.0277021149296877],[106.16719261370794,-6.0268881168890838],[106.16719203392599,-6.0266167842033811],[106.16692099979664,-6.0266173645433785],[106.16664996564076,-6.026617944748673]]],[[[106.16258445011751,-6.0266266316637225],[106.16258387264948,-6.0263552985287419],[106.16231283820379,-6.0263558765525724],[106.16231341553726,-6.026627209713765],[106.16258445011751,-6.0266266316637225]]],[[[106.16664996564076,-6.026617944748673],[106.16664938615449,-6.0263466120075817],[106.16637835210658,-6.0263471920518725],[106.16637893145835,-6.0266185248192663],[106.16664996564076,-6.026617944748673]]],[[[106.17559349479291,-6.026327394981565],[106.17532246162506,-6.0263279794708113],[106.17532304541693,-6.0265993113670095],[106.17505201208776,-6.0265998957480589],[106.17505142843044,-6.0263285638253627],[106.17478039520907,-6.0263291480452184],[106.17478156228137,-6.0268718119408291],[106.1750525957719,-6.0268712276679883],[106.17532362923558,-6.026870643260442],[106.17559466267254,-6.0268700587181883],[106.17586569608271,-6.0268694740412281],[106.17586511199497,-6.0265981422008101],[106.17559407871934,-6.0265987268512609],[106.17559349479291,-6.026327394981565]]],[[[106.16177076923294,-6.0263570321961444],[106.16177019219505,-6.0260856989798333],[106.1612281233875,-6.0260868540322337],[106.16122870015629,-6.0263581873009224],[106.16177076923294,-6.0263570321961444]]],[[[106.16583802125861,-6.027162350188016],[106.16583744212288,-6.0268910173735533],[106.1655664077262,-6.0268915970663208],[106.16556582875158,-6.0266202642228244],[106.16529479446289,-6.0266208437546043],[106.16529363686239,-6.0260781780068058],[106.16502260281625,-6.0260787573513399],[106.1647515687436,-6.0260793365611827],[106.1647521472615,-6.026350669488977],[106.1644811130278,-6.0263512485903874],[106.16421007876755,-6.026351827557102],[106.16421065704287,-6.026623160534692],[106.16448169143767,-6.0266225815417256],[106.16448284833699,-6.0271652474361161],[106.16421181367305,-6.0271658264815908],[106.16421239202792,-6.0274371594508809],[106.16448342682642,-6.0274365803791534],[106.16475446159838,-6.0274360011727044],[106.16475388297435,-6.027164668255927],[106.16502491758523,-6.0271640889410216],[106.16502433885319,-6.0268927560477268],[106.16529537330297,-6.0268921766243775],[106.16529595216957,-6.0271635094914018],[106.16583802125861,-6.027162350188016]]],[[[106.17640659413578,-6.0263256407056591],[106.17667762719654,-6.0263250556776349],[106.1766770427587,-6.0260537239112972],[106.17640600983252,-6.0260543089127934],[106.17613497687954,-6.0260548937796017],[106.17613556104827,-6.0263262255989885],[106.17640659413578,-6.0263256407056591]]],[[[106.16502144559097,-6.0255360915400002],[106.16502086701811,-6.0252647586301888],[106.16474983334906,-6.0252653377612369],[106.16475041178738,-6.0255366706973117],[106.16502144559097,-6.0255360915400002]]],[[[106.16637835210658,-6.0263471920518725],[106.16637719348284,-6.0258045265088853],[106.16610615967741,-6.0258051063658868],[106.16610558053991,-6.0255337735639642],[106.16610500142895,-6.0252624407592759],[106.16583396786605,-6.025263020429013],[106.16583454684249,-6.0255343532599914],[106.16556351311854,-6.0255349328213397],[106.16556409198698,-6.0258062656758371],[106.16529305810192,-6.0258068451287832],[106.16529363686239,-6.0260781780068058],[106.16556467088196,-6.0260775985275812],[106.16556524980351,-6.0263489313765604],[106.16637835210658,-6.0263471920518725]]],[[[106.16908636886657,-6.0252560555038057],[106.16908578830245,-6.0249847229859927],[106.16881475516655,-6.024985304110765],[106.16881533559615,-6.0252566366549356],[106.16908636886657,-6.0252560555038057]]],[[[106.16664590979474,-6.0247186155034056],[106.1666464891216,-6.0249899482609788],[106.16691752247033,-6.0249893682135323],[106.1669169430089,-6.0247180354822678],[106.16664590979474,-6.0247186155034056]]],[[[106.16664590979474,-6.0247186155034056],[106.16664533049445,-6.0244472827430497],[106.16637429738822,-6.0244478626032256],[106.16637487655402,-6.024719195389884],[106.16664590979474,-6.0247186155034056]]]]
          },
          "properties": {
            "OBJECTID": 1,
            "Id": 1,
            "gridcode": 2,
            "Shape_Length": 7740.0000000158325,
            "Shape_Area": 100800.00000157859,
            "luasan": 10.083890426962874
          }
        },
        {
          "type": "Feature",
          "id": 2,
          "geometry": {
            "type": "MultiPolygon",
            "coordinates": [[[[106.17342756026146,-6.0274173954337096],[106.17315652634143,-6.0274179789512159],[106.17315710916378,-6.0276893110482384],[106.17342814321839,-6.0276887275042759],[106.17342756026146,-6.0274173954337096]]],[[[106.16827733084433,-6.0271571266543829],[106.16827791121774,-6.027428459229232],[106.16854894561779,-6.0274278781366872],[106.1685483651098,-6.0271565455881833],[106.16827733084433,-6.0271571266543829]]],[[[106.16936204865816,-6.0274261340507298],[106.16963308295168,-6.0274255524193014],[106.16963250190543,-6.0271542199762393],[106.16909043356085,-6.0271553830516398],[106.16881939934865,-6.0271559643872683],[106.1688199799912,-6.0274272969094209],[106.16936204865816,-6.0274261340507298]]],[[[106.17044618567247,-6.0274238067166985],[106.17044560422255,-6.0271524743527793],[106.17017457014346,-6.0271530563619802],[106.17017515145886,-6.0274243887522871],[106.17044618567247,-6.0274238067166985]]],[[[106.17261387589467,-6.0271478134294734],[106.17234284202905,-6.0271483965163855],[106.172343424421,-6.0274197286954188],[106.17261445842121,-6.0274191455820709],[106.17261387589467,-6.0271478134294734]]],[[[106.1761373137152,-6.027140221040713],[106.17613789799108,-6.0274115528490784],[106.17640893161683,-6.0274109678496606],[106.17667996521578,-6.0274103827155256],[106.17667938067078,-6.0271390509602085],[106.1761373137152,-6.027140221040713]]],[[[106.16827733084433,-6.0271571266543829],[106.16827675049755,-6.0268857940767484],[106.16773468215591,-6.0268869557523344],[106.16773526223359,-6.0271582883826387],[106.16800629655226,-6.027157707585868],[106.16827733084433,-6.0271571266543829]]],[[[106.17261387589467,-6.0271478134294734],[106.17288490973355,-6.0271472302078486],[106.17288432709921,-6.0268758980789094],[106.17261329339487,-6.0268764812740923],[106.17261387589467,-6.0271478134294734]]],[[[106.17369859415477,-6.0274168117814826],[106.17369742805195,-6.0268741476851178],[106.17315536077685,-6.0268753147490184],[106.17315594354578,-6.0271466468515102],[106.17342697733126,-6.0271460633604583],[106.17342756026146,-6.0274173954337096],[106.17369859415477,-6.0274168117814826]]],[[[106.17369859415477,-6.0274168117814826],[106.17369917724628,-6.0276881438255892],[106.17424124522188,-6.0276869760640386],[106.1742418286093,-6.0279583080524191],[106.17451286269156,-6.0279577239430759],[106.17451227916958,-6.0276863919811747],[106.1747833130905,-6.0276858077635849],[106.1747827294607,-6.0274144758253838],[106.17451169567435,-6.0274150600164873],[106.17451111220586,-6.0271437280491167],[106.17478214585765,-6.0271431438844987],[106.17478156228137,-6.0268718119408291],[106.17423949522015,-6.0268729800823877],[106.17424007852735,-6.027144312079022],[106.17396904482202,-6.0271448959742147],[106.17396962802137,-6.0274162279945376],[106.17369859415477,-6.0274168117814826]]],[[[106.17532421308101,-6.0271419751511228],[106.17532362923558,-6.026870643260442],[106.1750525957719,-6.0268712276679883],[106.1750531794827,-6.0271425595851671],[106.17532421308101,-6.0271419751511228]]],[[[106.1761373137152,-6.027140221040713],[106.17613672946611,-6.0268688892295605],[106.17586569608271,-6.0268694740412281],[106.17559466267254,-6.0268700587181883],[106.17559524665252,-6.027141390582365],[106.17532421308101,-6.0271419751511228],[106.17532479695316,-6.0274133070390192],[106.17586686433856,-6.027412137713779],[106.17586628019724,-6.0271408058788953],[106.1761373137152,-6.027140221040713]]],[[[106.16366974426568,-6.0271669841683915],[106.16366916620645,-6.0268956511438283],[106.16366858817375,-6.0266243181165171],[106.16339755369943,-6.0266248967053739],[106.16339813159759,-6.026896229758921],[106.16312709696221,-6.0268968082393028],[106.1631276747523,-6.0271681413163289],[106.16339870952224,-6.0271675628097174],[106.16339928747344,-6.0274388958577312],[106.16367032235142,-6.0274383171901684],[106.16366974426568,-6.0271669841683915]]],[[[106.16746364794523,-6.0268875363880623],[106.1674630680287,-6.0266162037286808],[106.16719203392599,-6.0266167842033811],[106.16719261370794,-6.0268881168890838],[106.16746364794523,-6.0268875363880623]]],[[[106.17423949522015,-6.0268729800823877],[106.17423891193972,-6.0266016480830018],[106.17396787850355,-6.0266022319252475],[106.17396846164942,-6.0268735639511064],[106.17423949522015,-6.0268729800823877]]],[[[106.16258387264948,-6.0263552985287419],[106.16258445011751,-6.0266266316637225],[106.1628554846713,-6.0266260534789762],[106.16312651919861,-6.026625475159527],[106.16312594146149,-6.0263541420769853],[106.16258387264948,-6.0263552985287419]]],[[[106.16664938615449,-6.0263466120075817],[106.16664996564076,-6.026617944748673],[106.16692099979664,-6.0266173645433785],[106.16692042017581,-6.026346031828596],[106.16664938615449,-6.0263466120075817]]],[[[106.17667821166114,-6.0265963874412547],[106.17667762719654,-6.0263250556776349],[106.17640659413578,-6.0263256407056591],[106.17640717846587,-6.0265969724958071],[106.17667821166114,-6.0265963874412547]]],[[[106.16258387264948,-6.0263552985287419],[106.16258329520795,-6.0260839653910443],[106.1623122608968,-6.0260845433886656],[106.16177019219505,-6.0260856989798333],[106.16177076923294,-6.0263570321961444],[106.16231283820379,-6.0263558765525724],[106.16258387264948,-6.0263552985287419]]],[[[106.1647515687436,-6.0260793365611827],[106.16448053464444,-6.0260799156363349],[106.1644811130278,-6.0263512485903874],[106.1647521472615,-6.026350669488977],[106.1647515687436,-6.0260793365611827]]],[[[106.17532304541693,-6.0265993113670095],[106.17532246162506,-6.0263279794708113],[106.17532187785997,-6.0260566475718935],[106.17505084479987,-6.0260572318999488],[106.17505142843044,-6.0263285638253627],[106.17505201208776,-6.0265998957480589],[106.17532304541693,-6.0265993113670095]]],[[[106.16664938615449,-6.0263466120075817],[106.16664822726163,-6.0258039465171995],[106.16637719348284,-6.0258045265088853],[106.16637835210658,-6.0263471920518725],[106.16664938615449,-6.0263466120075817]]],[[[106.1647515687436,-6.0260793365611827],[106.16502260281625,-6.0260787573513399],[106.16502144559097,-6.0255360915400002],[106.16475041178738,-6.0255366706973117],[106.1647515687436,-6.0260793365611827]]],[[[106.16637719348284,-6.0258045265088853],[106.16637661421076,-6.0255331937332599],[106.16610558053991,-6.0255337735639642],[106.16610615967741,-6.0258051063658868],[106.16637719348284,-6.0258045265088853]]],[[[106.16881533559615,-6.0252566366549356],[106.16881475516655,-6.024985304110765],[106.16827268881491,-6.0249864659563128],[106.16827326897547,-6.0252577985531799],[106.16881533559615,-6.0252566366549356]]],[[[106.1666464891216,-6.0249899482609788],[106.16664590979474,-6.0247186155034056],[106.16637487655402,-6.024719195389884],[106.16637545574636,-6.0249905281737579],[106.1666464891216,-6.0249899482609788]]]]
          },
          "properties": {
            "OBJECTID": 2,
            "Id": 2,
            "gridcode": 3,
            "Shape_Length": 4679.999999942258,
            "Shape_Area": 47699.999998533167,
            "luasan": 4.7718361743372695
          }
        },
        {
          "type": "Feature",
          "id": 4,
          "geometry": {
            "type": "MultiPolygon",
            "coordinates": [[[[106.17451344624027,-6.0282290559022096],[106.17451286269156,-6.0279577239430759],[106.1742418286093,-6.0279583080524191],[106.17424241202342,-6.028229640038032],[106.17451344624027,-6.0282290559022096]]],[[[106.17044560422255,-6.0271524743527793],[106.17044618567247,-6.0274238067166985],[106.17180135634051,-6.0274208945179559],[106.17207239039409,-6.0274203116740477],[106.17207180813672,-6.027148979468584],[106.17044560422255,-6.0271524743527793]]],[[[106.16394077898262,-6.0271664053923484],[106.16394020078883,-6.0268950723940273],[106.16366916620645,-6.0268956511438283],[106.16366974426568,-6.0271669841683915],[106.16394077898262,-6.0271664053923484]]],[[[106.17044560422255,-6.0271524743527793],[106.1704450227992,-6.0268811419860766],[106.16908985281037,-6.0268840505530594],[106.16909043356085,-6.0271553830516398],[106.16963250190543,-6.0271542199762393],[106.17017457014346,-6.0271530563619802],[106.17044560422255,-6.0271524743527793]]],[[[106.17261329339487,-6.0268764812740923],[106.17234225966381,-6.0268770643345668],[106.17234284202905,-6.0271483965163855],[106.17261387589467,-6.0271478134294734],[106.17261329339487,-6.0268764812740923]]],[[[106.17559524665252,-6.027141390582365],[106.17559466267254,-6.0268700587181883],[106.17532362923558,-6.026870643260442],[106.17532421308101,-6.0271419751511228],[106.17559524665252,-6.027141390582365]]],[[[106.17667938067078,-6.0271390509602085],[106.17667879615256,-6.026867719202107],[106.17640776282276,-6.0268683042831874],[106.17613672946611,-6.0268688892295605],[106.1761373137152,-6.027140221040713],[106.17667938067078,-6.0271390509602085]]],[[[106.1688182381434,-6.0266132993346426],[106.1674630680287,-6.0266162037286808],[106.16746364794523,-6.0268875363880623],[106.16773468215591,-6.0268869557523344],[106.16827675049755,-6.0268857940767484],[106.16827733084433,-6.0271571266543829],[106.1685483651098,-6.0271565455881833],[106.16854894561779,-6.0274278781366872],[106.1688199799912,-6.0274272969094209],[106.16881939934865,-6.0271559643872683],[106.1688182381434,-6.0266132993346426]]],[[[106.17261329339487,-6.0268764812740923],[106.17288432709921,-6.0268758980789094],[106.17315536077685,-6.0268753147490184],[106.17369742805195,-6.0268741476851178],[106.17396846164942,-6.0268735639511064],[106.17396787850355,-6.0266022319252475],[106.17369684504064,-6.026602815632792],[106.17342581155101,-6.0266033992056354],[106.17261271092178,-6.0266051491159587],[106.17261329339487,-6.0268764812740923]]],[[[106.16692042017581,-6.026346031828596],[106.16692099979664,-6.0266173645433785],[106.16719203392599,-6.0266167842033811],[106.16719145417059,-6.0263454515149126],[106.16692042017581,-6.026346031828596]]],[[[106.16258329520795,-6.0260839653910443],[106.16258387264948,-6.0263552985287419],[106.16312594146149,-6.0263541420769853],[106.16312536375086,-6.0260828089917258],[106.16258329520795,-6.0260839653910443]]],[[[106.16421007876755,-6.026351827557102],[106.1644811130278,-6.0263512485903874],[106.16448053464444,-6.0260799156363349],[106.16393846636652,-6.0260810733825645],[106.16393904448078,-6.026352406389119],[106.16421007876755,-6.026351827557102]]],[[[106.16258329520795,-6.0260839653910443],[106.16258271779289,-6.0258126322505801],[106.16231168361629,-6.0258132102219912],[106.1623122608968,-6.0260845433886656],[106.16258329520795,-6.0260839653910443]]],[[[106.16692042017581,-6.026346031828596],[106.16691926101387,-6.0258033663908295],[106.16664822726163,-6.0258039465171995],[106.16664938615449,-6.0263466120075817],[106.16692042017581,-6.026346031828596]]],[[[106.17450819526472,-6.0257870681708319],[106.17450936196093,-6.0263297321303817],[106.17423832868604,-6.0263303160808492],[106.17423891193972,-6.0266016480830018],[106.17423949522015,-6.0268729800823877],[106.17478156228137,-6.0268718119408291],[106.17478039520907,-6.0263291480452184],[106.17477922824378,-6.0257864841386413],[106.17450819526472,-6.0257870681708319]]],[[[106.16664822726163,-6.0258039465171995],[106.16664764785504,-6.0255326137678757],[106.16637661421076,-6.0255331937332599],[106.16637719348284,-6.0258045265088853],[106.16664822726163,-6.0258039465171995]]],[[[106.17450819526472,-6.0257870681708319],[106.17450761195673,-6.0255157361869243],[106.17423657908547,-6.025516320057954],[106.17423716225892,-6.0257876520683418],[106.17450819526472,-6.0257870681708319]]],[[[106.17071314932763,-6.0255238981257531],[106.17071256792975,-6.025252565768926],[106.17017050168194,-6.0252537295525714],[106.17017108281078,-6.0255250619621803],[106.17071314932763,-6.0255238981257531]]],[[[106.16637661421076,-6.0255331937332599],[106.16637603496528,-6.0252618609548669],[106.16718913541486,-6.0252601207336047],[106.16718855579244,-6.024988788031421],[106.16691752247033,-6.0249893682135323],[106.1666464891216,-6.0249899482609788],[106.16637545574636,-6.0249905281737579],[106.16610442234456,-6.0249911079518714],[106.16610500142895,-6.0252624407592759],[106.16610558053991,-6.0255337735639642],[106.16637661421076,-6.0255331937332599]]],[[[106.16827326897547,-6.0252577985531799],[106.16827268881491,-6.0249864659563128],[106.16773062235683,-6.0249876272631981],[106.16773120224835,-6.025258959912736],[106.16827326897547,-6.0252577985531799]]]]
          },
          "properties": {
            "OBJECTID": 4,
            "Id": 4,
            "gridcode": 4,
            "Shape_Length": 4379.999999973923,
            "Shape_Area": 49499.999998770654,
            "luasan": 4.9519075878202052
          }
        },
        {
          "type": "Feature",
          "id": 10,
          "geometry": {
            "type": "MultiPolygon",
            "coordinates": [[[[106.17667879615256,-6.026867719202107],[106.17667938067078,-6.0271390509602085],[106.17695041410835,-6.0271384657178881],[106.17694982945557,-6.0268671339863209],[106.17667879615256,-6.026867719202107]]],[[[106.16394020078883,-6.0268950723940273],[106.1639396226216,-6.0266237393929565],[106.16366858817375,-6.0266243181165171],[106.16366916620645,-6.0268956511438283],[106.16394020078883,-6.0268950723940273]]],[[[106.17667879615256,-6.026867719202107],[106.17667821166114,-6.0265963874412547],[106.17640717846587,-6.0265969724958071],[106.17640776282276,-6.0268683042831874],[106.17667879615256,-6.026867719202107]]],[[[106.16393846636652,-6.0260810733825645],[106.16448053464444,-6.0260799156363349],[106.1647515687436,-6.0260793365611827],[106.16475041178738,-6.0255366706973117],[106.16447937795729,-6.025537249719946],[106.16447995628761,-6.025808582679514],[106.16258271779289,-6.0258126322505801],[106.16258329520795,-6.0260839653910443],[106.16312536375086,-6.0260828089917258],[106.16312594146149,-6.0263541420769853],[106.16393904448078,-6.026352406389119],[106.16393846636652,-6.0260810733825645]]],[[[106.17423657908547,-6.025516320057954],[106.17369451326269,-6.0255174873959838],[106.17369684504064,-6.026602815632792],[106.17396787850355,-6.0266022319252475],[106.17423891193972,-6.0266016480830018],[106.17423832868604,-6.0263303160808492],[106.17450936196093,-6.0263297321303817],[106.17450819526472,-6.0257870681708319],[106.17423716225892,-6.0257876520683418],[106.17423657908547,-6.025516320057954]]],[[[106.17288141432809,-6.0255192373929534],[106.172880831854,-6.0252479052474941],[106.17071256792975,-6.025252565768926],[106.17071314932763,-6.0255238981257531],[106.17288141432809,-6.0255192373929534]]],[[[106.16773062235683,-6.0249876272631981],[106.16718855579244,-6.024988788031421],[106.16718913541486,-6.0252601207336047],[106.16637603496528,-6.0252618609548669],[106.16637661421076,-6.0255331937332599],[106.16664764785504,-6.0255326137678757],[106.16664822726163,-6.0258039465171995],[106.16691926101387,-6.0258033663908295],[106.16692042017581,-6.026346031828596],[106.16719145417059,-6.0263454515149126],[106.16719203392599,-6.0266167842033811],[106.1674630680287,-6.0266162037286808],[106.1688182381434,-6.0266132993346426],[106.16881939934865,-6.0271559643872683],[106.16909043356085,-6.0271553830516398],[106.16908985281037,-6.0268840505530594],[106.1704450227992,-6.0268811419860766],[106.17044560422255,-6.0271524743527793],[106.17207180813672,-6.027148979468584],[106.17207239039409,-6.0274203116740477],[106.172343424421,-6.0274197286954188],[106.17234284202905,-6.0271483965163855],[106.17234225966381,-6.0268770643345668],[106.17261329339487,-6.0268764812740923],[106.17261271092178,-6.0266051491159587],[106.17342581155101,-6.0266033992056354],[106.17342522870098,-6.0263320671240814],[106.17315419531916,-6.0263326505357693],[106.17315302996836,-6.0257899863115503],[106.17288199682889,-6.025790569535646],[106.1728825793564,-6.0260619016755879],[106.1723405127283,-6.0260630677726077],[106.1723399304699,-6.0257917355797872],[106.1715268307311,-6.0257934836358755],[106.17152741258592,-6.0260648159079686],[106.17125637915174,-6.0260653983503776],[106.17125579743148,-6.0257940660518718],[106.16908753007469,-6.0257987205312338],[106.16908694945731,-6.0255273880189044],[106.17017108281078,-6.0255250619621803],[106.17017050168194,-6.0252537295525714],[106.16908636886657,-6.0252560555038057],[106.16881533559615,-6.0252566366549356],[106.16827326897547,-6.0252577985531799],[106.16773120224835,-6.025258959912736],[106.16773062235683,-6.0249876272631981]]]]
          },
          "properties": {
            "OBJECTID": 10,
            "Id": 10,
            "gridcode": 5,
            "Shape_Length": 4499.9999999916181,
            "Shape_Area": 132300.0000010198,
            "luasan": 13.23509829456801
          }
        },
        {
          "type": "Feature",
          "id": 16,
          "geometry": {
            "type": "MultiPolygon",
            "coordinates": [[[[106.16584323467505,-6.0296043453944037],[106.16530116316329,-6.0296055051708457],[106.16530174229531,-6.0298768380103622],[106.16584381407627,-6.0298756781813578],[106.16584323467505,-6.0296043453944037]]],[[[106.16584323467505,-6.0296043453944037],[106.16611427039109,-6.0296037653040271],[106.16611369088179,-6.0293324325405937],[106.16584265530034,-6.0293330126046811],[106.16584323467505,-6.0296043453944037]]],[[[106.16828023297744,-6.0285137895012566],[106.16827965249762,-6.0282424569373934],[106.16800861766721,-6.0282430379742333],[106.16800919801246,-6.0285143705644355],[106.16828023297744,-6.0285137895012566]]],[[[106.16828023297744,-6.0285137895012566],[106.16828081348389,-6.0287851220624198],[106.16990702352236,-6.0287816326955319],[106.1699064422083,-6.028510300292532],[106.16936437257125,-6.0285114639010864],[106.16936379155298,-6.0282401314426401],[106.16909275682907,-6.0282407130184366],[106.1690933377127,-6.0285120455032466],[106.16855126791583,-6.0285132083033313],[106.16828023297744,-6.0285137895012566]]],[[[106.16963424512409,-6.0279682172972775],[106.16963482625026,-6.0282395497321053],[106.16990586092095,-6.0282389678868311],[106.16990527966016,-6.0279676354783787],[106.16963424512409,-6.0279682172972775]]],[[[106.17315944072037,-6.0287746394086801],[106.17315827488865,-6.0282319752339451],[106.17342930921242,-6.0282313916370738],[106.17342872620205,-6.0279600595720586],[106.17315769201286,-6.0279606431424755],[106.17261562355432,-6.0279618098791135],[106.17261678879426,-6.0285044741650839],[106.17234575425572,-6.0285050573841792],[106.17234633678115,-6.028776389549523],[106.17315944072037,-6.0287746394086801]]],[[[106.16746538785434,-6.0277015343497053],[106.16746596787721,-6.027972866998085],[106.16773700262618,-6.0279722862570502],[106.16800803734857,-6.0279717053812805],[106.16800745705653,-6.0277003727855609],[106.16746538785434,-6.0277015343497053]]],[[[106.16827849161777,-6.0276997918013979],[106.16827907204437,-6.0279711243707794],[106.16855010671357,-6.0279705432255444],[106.16854952615236,-6.027699210682508],[106.16827849161777,-6.0276997918013979]]],[[[106.17098999933702,-6.0282366391583491],[106.17098883576544,-6.0276939745498028],[106.17044676714907,-6.0276951390779328],[106.17044793018229,-6.0282378037920665],[106.17071896477296,-6.028237221542577],[106.17071954646413,-6.0285085538691154],[106.17099058116276,-6.0285079714584864],[106.17098999933702,-6.0282366391583491]]],[[[106.17180252066618,-6.0279635589735809],[106.17180193849001,-6.0276922267471615],[106.17153090427519,-6.027692809482768],[106.17153148631677,-6.0279641417356062],[106.17180252066618,-6.0279635589735809]]],[[[106.16827849161777,-6.0276997918013979],[106.16827791121774,-6.027428459229232],[106.1680068767911,-6.0274290401870561],[106.16800745705653,-6.0277003727855609],[106.16827849161777,-6.0276997918013979]]],[[[106.16963424512409,-6.0279682172972775],[106.16963308295168,-6.0274255524193014],[106.16936204865816,-6.0274261340507298],[106.16936262959646,-6.0276974665174778],[106.16909159514172,-6.0276980480405484],[106.16909217597208,-6.0279693805308758],[106.16963424512409,-6.0279682172972775]]],[[[106.1766805497876,-6.0276817144681578],[106.17667996521578,-6.0274103827155256],[106.17640893161683,-6.0274109678496606],[106.17640951605411,-6.0276822996288217],[106.1766805497876,-6.0276817144681578]]],[[[106.16421181367305,-6.0271658264815908],[106.16394077898262,-6.0271664053923484],[106.16394135720292,-6.0274377383878859],[106.16421239202792,-6.0274371594508809],[106.16421181367305,-6.0271658264815908]]],[[[106.16502491758523,-6.0271640889410216],[106.16475388297435,-6.027164668255927],[106.16475446159838,-6.0274360011727044],[106.16448342682642,-6.0274365803791534],[106.16448516245384,-6.028250579191881],[106.16475619762954,-6.0282499999066523],[106.16475677635965,-6.0285213328124447],[106.16502781164344,-6.0285207533662124],[106.16502491758523,-6.0271640889410216]]],[[[106.16502491758523,-6.0271640889410216],[106.16529595216957,-6.0271635094914018],[106.16529537330297,-6.0268921766243775],[106.16502433885319,-6.0268927560477268],[106.16502491758523,-6.0271640889410216]]],[[[106.1680068767911,-6.0274290401870561],[106.16800629655226,-6.027157707585868],[106.16773526223359,-6.0271582883826387],[106.16746422788835,-6.0271588690446949],[106.16746364794523,-6.0268875363880623],[106.16719261370794,-6.0268881168890838],[106.16719435321333,-6.0277021149296877],[106.16746538785434,-6.0277015343497053],[106.16746480785804,-6.0274302016985422],[106.1680068767911,-6.0274290401870561]]],[[[106.1750531794827,-6.0271425595851671],[106.1750525957719,-6.0268712276679883],[106.17478156228137,-6.0268718119408291],[106.17478214585765,-6.0271431438844987],[106.1750531794827,-6.0271425595851671]]],[[[106.16285606230034,-6.0268973865849755],[106.1628554846713,-6.0266260534789762],[106.16258445011751,-6.0266266316637225],[106.16231341553726,-6.026627209713765],[106.16231399289718,-6.02689854287219],[106.16285606230034,-6.0268973865849755]]],[[[106.16421181367305,-6.0271658264815908],[106.16448284833699,-6.0271652474361161],[106.16448169143767,-6.0266225815417256],[106.16421065704287,-6.026623160534692],[106.16421181367305,-6.0271658264815908]]],[[[106.16556582875158,-6.0266202642228244],[106.1655664077262,-6.0268915970663208],[106.16583744212288,-6.0268910173735533],[106.16583802125861,-6.027162350188016],[106.16610905576333,-6.027161770334251],[106.16610963506018,-6.0274331031196384],[106.16665170425902,-6.0274319429553627],[106.16665112469303,-6.0271606102225732],[106.16638009024146,-6.0271611903457689],[106.16637893145835,-6.0266185248192663],[106.16556582875158,-6.0266202642228244]]],[[[106.16556582875158,-6.0266202642228244],[106.16556524980351,-6.0263489313765604],[106.16556467088196,-6.0260775985275812],[106.16529363686239,-6.0260781780068058],[106.16529479446289,-6.0266208437546043],[106.16556582875158,-6.0266202642228244]]],[[[106.17586452793398,-6.0263268103576237],[106.17613556104827,-6.0263262255989885],[106.17613497687954,-6.0260548937796017],[106.17640600983252,-6.0260543089127934],[106.17640542555603,-6.0257829771171609],[106.17586335989238,-6.0257841466630495],[106.17586394389976,-6.0260554785117213],[106.17532187785997,-6.0260566475718935],[106.17532246162506,-6.0263279794708113],[106.17559349479291,-6.026327394981565],[106.17559407871934,-6.0265987268512609],[106.17586511199497,-6.0265981422008101],[106.17586452793398,-6.0263268103576237]]],[[[106.16529363686239,-6.0260781780068058],[106.16529305810192,-6.0258068451287832],[106.16529247936802,-6.025535512248009],[106.16502144559097,-6.0255360915400002],[106.16502260281625,-6.0260787573513399],[106.16529363686239,-6.0260781780068058]]]]
          },
          "properties": {
            "OBJECTID": 16,
            "Id": 16,
            "gridcode": 1,
            "Shape_Length": 5339.9999999860302,
            "Shape_Area": 63900.000000139698,
            "luasan": 6.392465799699484
          }
        },
        {
          "type": "Feature",
          "id": 33,
          "geometry": {
            "type": "Polygon",
            "coordinates": [[[106.17369684504064,-6.026602815632792],[106.17369451326269,-6.0255174873959838],[106.17288141432809,-6.0255192373929534],[106.17071314932763,-6.0255238981257531],[106.17017108281078,-6.0255250619621803],[106.16908694945731,-6.0255273880189044],[106.16908753007469,-6.0257987205312338],[106.17125579743148,-6.0257940660518718],[106.17125637915174,-6.0260653983503776],[106.17152741258592,-6.0260648159079686],[106.1715268307311,-6.0257934836358755],[106.1723399304699,-6.0257917355797872],[106.1723405127283,-6.0260630677726077],[106.1728825793564,-6.0260619016755879],[106.17288199682889,-6.025790569535646],[106.17315302996836,-6.0257899863115503],[106.17315419531916,-6.0263326505357693],[106.17342522870098,-6.0263320671240814],[106.17342581155101,-6.0266033992056354],[106.17369684504064,-6.026602815632792]]]
          },
          "properties": {
            "OBJECTID": 33,
            "Id": 33,
            "gridcode": 6,
            "Shape_Length": 1380.000000002794,
            "Shape_Area": 22499.999999538995,
            "luasan": 2.2508636111714115
          }
        }
      ]
    };

    // ==================== TOGGLE CONTROLS ====================
    // Toggle Panel Kanan
    document.getElementById('togglePanelBtn').addEventListener('click', function() {
        const rightPanel = document.getElementById('rightPanel');
        rightPanel.style.display = rightPanel.style.display === 'none' ? 'block' : 'none';
    });

    // Toggle Statistics Panel
    document.getElementById('statsToggle').addEventListener('click', function() {
        const statsPanel = document.getElementById('statsPanel');
        statsPanel.style.display = statsPanel.style.display === 'none' ? 'block' : 'none';
    });

    // Close Statistics Panel
    document.getElementById('statsClose').addEventListener('click', function() {
        document.getElementById('statsPanel').style.display = 'none';
    });

    // Collapsible Sections
    document.querySelectorAll('.collapsible-header').forEach(header => {
        header.addEventListener('click', function() {
            const collapsible = this.parentElement;
            collapsible.classList.toggle('hidden');
            const arrow = this.querySelector('span:last-child');
            arrow.textContent = collapsible.classList.contains('hidden') ? '‚ñ∂' : '‚ñº';
        });
    });

    // Toggle Basemap Panel
    document.getElementById('basemapFlipBtn').addEventListener('click', function() {
        const basemapCard = document.getElementById('basemapCard');
        basemapCard.classList.toggle('hidden');
    });

    // Tutup Panel Kanan
    document.getElementById('closePanel').addEventListener('click', function() {
        document.getElementById('rightPanel').style.display = 'none';
    });

    // Pilih Basemap
    document.querySelectorAll('.basemap-item').forEach(item => {
        item.addEventListener('click', function() {
            const basemap = this.getAttribute('data-basemap');
            
            document.querySelectorAll('.basemap-item').forEach(el => {
                el.classList.remove('active');
            });
            
            this.classList.add('active');
            
            if (basemaps[currentBasemap]) {
                map.removeLayer(basemaps[currentBasemap]);
            }
            
            basemaps[basemap].addTo(map);
            currentBasemap = basemap;
            
            document.getElementById('basemapCard').classList.add('hidden');
        });
    });

    // Toolbar Controls
    document.getElementById('zoomIn').addEventListener('click', function() {
        map.zoomIn();
    });

    document.getElementById('zoomOut').addEventListener('click', function() {
        map.zoomOut();
    });

    // Chatbox Toggle
    document.getElementById('chatHeader').addEventListener('click', function() {
        const chatContent = document.getElementById('chatContent');
        const chatInputRow = document.querySelector('.chat-input-row');
        
        if (chatContent.style.display === 'none') {
            chatContent.style.display = 'flex';
            chatInputRow.style.display = 'flex';
            this.querySelector('span:last-child').textContent = '‚àí';
        } else {
            chatContent.style.display = 'none';
            chatInputRow.style.display = 'none';
            this.querySelector('span:last-child').textContent = '+';
        }
    });

    // Search Functionality
    document.getElementById('doSearch').addEventListener('click', function() {
        performSearch();
    });

    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });

    function performSearch() {
        const query = document.getElementById('searchInput').value.trim();
        
        if (!query) return;
        
        // Cek jika query adalah koordinat
        const coordMatch = query.match(/^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/);
        
        if (coordMatch) {
            const lat = parseFloat(coordMatch[1]);
            const lng = parseFloat(coordMatch[2]);
            
            if (!isNaN(lat) && !isNaN(lng)) {
                map.setView([lat, lng], 16);
                L.marker([lat, lng]).addTo(map)
                    .bindPopup(`Lokasi: ${lat}, ${lng}`)
                    .openPopup();
                return;
            }
        }
        
        alert('Silakan gunakan format koordinat: latitude,longitude (contoh: -6.029,106.165)');
    }

    // ==================== SISTEM INTEGRASI GEOJSON ====================
    let geoJSONLayer = null;
    let densityChart = null;
    let currentFilter = 'all';

    // Fungsi untuk memuat dan menampilkan data GeoJSON
    function loadGeoJSONData() {
        // Hapus layer sebelumnya jika ada
        if (geoJSONLayer) {
            map.removeLayer(geoJSONLayer);
        }
        
        const data = eviKarangantu2024;
        
        // Hitung statistik
        calculateStatistics(data);
        
        // Style berdasarkan gridcode (kerapatan vegetasi)
        function getStyleByGridcode(feature) {
            const gridcode = feature.properties.gridcode;
            let color, opacity, weight;
            
            switch(gridcode) {
                case 1: // Sangat Rendah
                    color = '#ffffcc';
                    opacity = 0.7;
                    weight = 1;
                    break;
                case 2: // Rendah
                    color = '#c2e699';
                    opacity = 0.7;
                    weight = 1;
                    break;
                case 3: // Sedang-Rendah
                    color = '#78c679';
                    opacity = 0.7;
                    weight = 1.5;
                    break;
                case 4: // Sedang
                    color = '#31a354';
                    opacity = 0.8;
                    weight = 2;
                    break;
                case 5: // Tinggi
                    color = '#006837';
                    opacity = 0.9;
                    weight = 2.5;
                    break;
                case 6: // Sangat Tinggi
                    color = '#004529';
                    opacity = 1;
                    weight = 3;
                    break;
                default:
                    color = '#808080';
                    opacity = 0.5;
                    weight = 1;
            }
            
            return {
                fillColor: color,
                color: color,
                weight: weight,
                opacity: 0.8,
                fillOpacity: opacity
            };
        }
        
        // Filter function
        function filterByDensity(feature) {
            if (currentFilter === 'all') return true;
            return feature.properties.gridcode.toString() === currentFilter;
        }
        
        // Tambah layer GeoJSON ke peta
        geoJSONLayer = L.geoJSON(data, {
            style: getStyleByGridcode,
            filter: filterByDensity,
            onEachFeature: function(feature, layer) {
                const props = feature.properties;
                
                let popupContent = `
                    <div style="max-width: 280px;">
                        <h4 style="margin:0 0 8px 0; color: #0a5c36; border-bottom: 2px solid #0a5c36; padding-bottom: 4px;">
                            EVI Karangantu 2024 - Poligon ${props.Id}
                        </h4>
                        <div style="font-size: 12px; color: #333; line-height: 1.4;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <strong>Kerapatan:</strong> 
                                <span style="color: ${getColorByGridcode(props.gridcode)}; font-weight: bold;">
                                    ${getKerapatanLabel(props.gridcode)}
                                </span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <strong>Gridcode:</strong> <span>${props.gridcode || 'N/A'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <strong>Luasan:</strong> <span>${props.luasan ? props.luasan.toFixed(2) + ' ha' : 'N/A'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <strong>Shape Length:</strong> <span>${props.Shape_Length ? props.Shape_Length.toFixed(2) + ' m' : 'N/A'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <strong>Shape Area:</strong> <span>${props.Shape_Area ? (props.Shape_Area / 10000).toFixed(2) + ' ha' : 'N/A'}</span>
                            </div>
                        </div>
                `;
                
                // Tambahkan info tambahan berdasarkan gridcode
                popupContent += `
                    <div style="margin-top: 8px; padding: 6px; background: #f8f9fa; border-radius: 4px; font-size: 11px; border-left: 3px solid ${getColorByGridcode(props.gridcode)};">
                        <strong>Indeks Vegetasi:</strong> ${getKerapatanLabel(props.gridcode)}<br>
                        <div style="width: 100%; height: 8px; background: linear-gradient(90deg, #ffffcc, #004529); margin: 4px 0; border-radius: 4px; position: relative;">
                            <div style="position: absolute; left: ${((props.gridcode - 1) / 5) * 100}%; width: 20%; height: 100%; background: ${getColorByGridcode(props.gridcode)}; border-radius: 4px;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 9px; color: #666;">
                            <span>Sangat Rendah</span>
                            <span>Sangat Tinggi</span>
                        </div>
                    </div>
                `;
                
                popupContent += `</div>`;
                layer.bindPopup(popupContent);
                
                // Tooltip
                layer.bindTooltip(`EVI Karangantu 2024 - ${getKerapatanLabel(props.gridcode)} (${props.luasan} ha)`, {
                    permanent: false,
                    direction: 'auto',
                    className: 'custom-tooltip'
                });
            }
        }).addTo(map);
        
        // Fit bounds ke data
        map.fitBounds(geoJSONLayer.getBounds());
        
        console.log(`Data EVI Karangantu 2024 berhasil dimuat - ${data.features.length} fitur`);
    }

    // Fungsi untuk mendapatkan label kerapatan
    function getKerapatanLabel(gridcode) {
        switch(gridcode) {
            case 1: return "Sangat Rendah";
            case 2: return "Rendah";
            case 3: return "Sedang-Rendah";
            case 4: return "Sedang";
            case 5: return "Tinggi";
            case 6: return "Sangat Tinggi";
            default: return "Tidak Diketahui";
        }
    }

    // Fungsi untuk menghitung statistik
    function calculateStatistics(data) {
        let totalLuasan = 0;
        let jumlahPoligon = data.features.length;
        let luasanMax = 0;
        let luasanMin = Infinity;
        let kerapatanRata = 0;
        
        const densityCount = {
            1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0
        };
        
        data.features.forEach(feature => {
            const luasan = feature.properties.luasan || 0;
            const gridcode = feature.properties.gridcode || 1;
            
            totalLuasan += luasan;
            densityCount[gridcode]++;
            
            if (luasan > luasanMax) luasanMax = luasan;
            if (luasan < luasanMin) luasanMin = luasan;
            kerapatanRata += gridcode;
        });
        
        kerapatanRata = (kerapatanRata / jumlahPoligon).toFixed(1);
        
        // Update statistik panel
        document.getElementById('totalLuas').textContent = totalLuasan.toFixed(2) + ' ha';
        document.getElementById('jumlahPoligon').textContent = jumlahPoligon;
        document.getElementById('kerapatanRata').textContent = kerapatanRata;
        document.getElementById('luasMax').textContent = luasanMax.toFixed(2) + ' ha';
        document.getElementById('luasMin').textContent = luasanMin.toFixed(2) + ' ha';
        
        // Update detail kerapatan
        document.getElementById('detailSangatRendah').textContent = densityCount[1] + ' poligon';
        document.getElementById('detailRendah').textContent = densityCount[2] + ' poligon';
        document.getElementById('detailSedangRendah').textContent = densityCount[3] + ' poligon';
        document.getElementById('detailSedang').textContent = densityCount[4] + ' poligon';
        document.getElementById('detailTinggi').textContent = densityCount[5] + ' poligon';
        document.getElementById('detailSangatTinggi').textContent = densityCount[6] + ' poligon';
        
        // Update data display
        document.getElementById('dataSangatRendah').textContent = densityCount[1] + ' poligon';
        document.getElementById('dataRendah').textContent = densityCount[2] + ' poligon';
        document.getElementById('dataSedangRendah').textContent = densityCount[3] + ' poligon';
        document.getElementById('dataSedang').textContent = densityCount[4] + ' poligon';
        document.getElementById('dataTinggi').textContent = densityCount[5] + ' poligon';
        document.getElementById('dataSangatTinggi').textContent = densityCount[6] + ' poligon';
        
        // Update chart
        updateDensityChart(densityCount);
    }

    // Fungsi untuk update chart kerapatan
    function updateDensityChart(densityCount) {
        const ctx = document.getElementById('densityChart').getContext('2d');
        
        if (densityChart) {
            densityChart.destroy();
        }
        
        densityChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Sangat Rendah', 'Rendah', 'Sedang-Rendah', 'Sedang', 'Tinggi', 'Sangat Tinggi'],
                datasets: [{
                    label: 'Distribusi Kerapatan',
                    data: [
                        densityCount[1],
                        densityCount[2],
                        densityCount[3],
                        densityCount[4],
                        densityCount[5],
                        densityCount[6]
                    ],
                    backgroundColor: [
                        '#ffffcc',
                        '#c2e699',
                        '#78c679',
                        '#31a354',
                        '#006837',
                        '#004529'
                    ],
                    borderColor: [
                        '#d9d9a3',
                        '#a8c97f',
                        '#5fa85a',
                        '#298845',
                        '#005426',
                        '#003318'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            font: {
                                size: 10
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Distribusi Kerapatan EVI',
                        font: {
                            size: 12
                        }
                    }
                }
            }
        });
    }

    // Fungsi untuk mendapatkan warna berdasarkan gridcode
    function getColorByGridcode(gridcode) {
        switch(gridcode) {
            case 1: return '#ffffcc';
            case 2: return '#c2e699';
            case 3: return '#78c679';
            case 4: return '#31a354';
            case 5: return '#006837';
            case 6: return '#004529';
            default: return '#808080';
        }
    }

    // Filter functionality
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Update current filter
            currentFilter = this.getAttribute('data-density');
            
            // Reload GeoJSON data with filter
            loadGeoJSONData();
        });
    });

    // Download Data GeoJSON
    document.getElementById('downloadData').addEventListener('click', function() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(eviKarangantu2024, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "evi_karangantu_2024.geojson");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        
        alert('Data GeoJSON EVI Karangantu 2024 berhasil diunduh!');
    });

    // Screenshot functionality
    document.getElementById('screenshot').addEventListener('click', function() {
        alert('Fitur screenshot akan segera tersedia!');
    });

    // Export Report
    document.getElementById('exportReport').addEventListener('click', function() {
        alert('Fitur export laporan PDF akan segera tersedia!');
    });

    // ==================== LEGENDA DINAMIS ====================
    function updateLegend() {
        const legend = L.control({ position: 'bottomright' });
        
        legend.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'info legend');
            div.style.background = 'white';
            div.style.padding = '10px';
            div.style.borderRadius = '5px';
            div.style.boxShadow = '0 0 10px rgba(0,0,0,0.2)';
            
            const grades = [1, 2, 3, 4, 5, 6];
            const labels = [
                'Sangat Rendah (1)',
                'Rendah (2)', 
                'Sedang-Rendah (3)',
                'Sedang (4)',
                'Tinggi (5)',
                'Sangat Tinggi (6)'
            ];
            const colors = [
                '#ffffcc', '#c2e699', '#78c679', '#31a354', '#006837', '#004529'
            ];
            
            let legendHTML = '<h4 style="margin:0 0 8px 0;">Kerapatan EVI 2024</h4>';
            
            for (let i = 0; i < grades.length; i++) {
                legendHTML += `
                    <div style="display: flex; align-items: center; margin: 4px 0;">
                        <div style="width: 20px; height: 15px; background: ${colors[i]}; margin-right: 8px; border: 1px solid #666;"></div>
                        <span style="font-size: 12px;">${labels[i]}</span>
                    </div>
                `;
            }
            
            div.innerHTML = legendHTML;
            return div;
        };
        
        legend.addTo(map);
    }

    // ==================== KELAS KERAPATAN ====================
    const CLASSES = [
      { id: 'very-high', label: 'Sangat Tinggi', color: '#004529' },
      { id: 'high', label: 'Tinggi', color: '#006837' },
      { id: 'medium', label: 'Sedang', color: '#31a354' },
      { id: 'low-medium', label: 'Sedang-Rendah', color: '#78c679' },
      { id: 'low', label: 'Rendah', color: '#c2e699' },
      { id: 'very-low', label: 'Sangat Rendah', color: '#ffffcc' }
    ];

    // Render Kelas
    function renderClasses() {
      const classesList = document.getElementById('classesList');
      classesList.innerHTML = '';
      
      CLASSES.forEach(cls => {
        const item = document.createElement('div');
        item.className = 'class-item';
        item.innerHTML = `
          <div class="class-color" style="background:${cls.color}"></div>
          <div class="class-label">${cls.label}</div>
          <div class="switch"><div class="knob"></div></div>
        `;
        classesList.appendChild(item);
        
        // Switch event
        const switchEl = item.querySelector('.switch');
        switchEl.addEventListener('click', function() {
          this.classList.toggle('on');
        });
        switchEl.classList.add('on');
      });
    }

    // ==================== INISIALISASI ====================
    document.addEventListener('DOMContentLoaded', function() {
        renderClasses();
        updateLegend();
        
        // Load data EVI Karangantu 2024
        setTimeout(() => {
            loadGeoJSONData();
        }, 1000);
        
        // Scale update
        map.on('zoomend', function() {
            const zoom = map.getZoom();
            const scale = Math.round(591657550 / Math.pow(2, zoom - 1));
            document.getElementById('scaleBox').textContent = `Skala: 1:${scale.toLocaleString()}`;
        });
        map.fire('zoomend');
    });

  </script>

</body>
</html>