<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mangrove Guardian - Evisangiang 21</title>

  <!-- External Libraries -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/leaflet.draw/1.0.4/leaflet.draw-src.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/leaflet.draw/1.0.4/leaflet.draw-src.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

  <!-- Custom Styles -->
  <style>
    /* VARIABLES */
    :root{
      --mg-green:#0a5c36;
      --mg-green-light:#1a7d4e;
      --mg-green-dark:#064527;
      --panel:rgba(255,255,255,0.95);
      --muted:#51606a;
      --navbar-height: 60px; 
    }
    
    *{box-sizing:border-box; margin:0; padding:0;}
    
    html,body{height:100%; margin:0; font-family:'Segoe UI', system-ui, sans-serif; color:#15302a;}
    body{background:#f8f9fa;}
    #map{flex:1; z-index:1;}

    .topbar{
      height: var(--navbar-height);
      padding:0 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:var(--mg-green);
      color:#fff;
      position:sticky;
      top:0;
      z-index:1500;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-bottom: 1px solid var(--mg-green-dark);
    }
    
    .brand{
      font-weight:600;
      font-size:20px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    
    .nav-right-container{display:flex; align-items:center; gap:25px;}
    .nav-menu{display:flex; gap:25px}
    .nav-menu a{
      color:#fff;
      text-decoration:none;
      font-size:14px;
      font-weight:500;
      padding:8px 0;
      transition:opacity 0.2s;
    }
    .nav-menu a:hover{opacity:0.8;}
    .lang-switch{
      font-size:13px;
      cursor:pointer;
      background:rgba(255,255,255,0.15);
      padding:6px 12px;
      border-radius:4px;
      font-weight:500;
    }

    .chat-box-container{
      position:fixed;
      bottom:20px;
      right:20px;
      z-index:1600;
      width:350px;
      background:var(--panel);
      border-radius:8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      border:1px solid #e1e5e9;
      display:flex;
      flex-direction:column;
      max-height:500px;
    }
    
    .chat-header{
      background: var(--mg-green);
      color: #fff;
      padding: 12px 16px;
      font-weight: 600;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-radius:8px 8px 0 0;
    }
    
    .chat-content{
      padding: 16px;
      flex:1;
      overflow-y: auto;
      display:flex;
      flex-direction:column;
      gap:12px;
      max-height:300px;
    }
    
    .chat-input-row{
      display:flex;
      gap:8px;
      padding:12px 16px;
      border-top:1px solid #e1e5e9;
      background:#f8f9fa;
    }
    
    .chat-input-row input{
      flex:1;
      padding:10px 12px;
      border-radius:6px;
      border:1px solid #ddd;
      outline:none;
      font-size:14px;
      background:#fff;
    }
    
    .chat-input-row button{
      background:var(--mg-green);
      border:0;
      color:#fff;
      padding:10px 16px;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
    }

    .chat-message{
      padding:10px 14px;
      border-radius:8px;
      max-width:85%;
      font-size:14px;
      line-height:1.4;
    }
    
    .chat-user{
      background:#e3f2fd;
      align-self:flex-end;
      border-bottom-right-radius:2px;
    }
    
    .chat-bot{
      background:#f5f5f5;
      align-self:flex-start;
      border-bottom-left-radius:2px;
    }

    .app{
      height:calc(100vh - var(--navbar-height));
      position:relative;
      display:flex;
    }

    .search-row-container{
      position:absolute;
      top:20px;
      left:50%;
      transform:translateX(-50%);
      z-index:1300;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      width:90%;
      max-width:700px;
    }
    
    .search-row{
      display:flex;
      align-items:center;
      gap:8px;
      width:100%;
    }
    
    .search-box{
      display:flex;
      align-items:center;
      background:var(--panel);
      padding:8px 16px;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      width:100%;
      border:1px solid #e1e5e9;
      flex:1;
    }
    
    .search-box input{
      border:0;
      outline:none;
      padding:8px;
      font-size:14px;
      background:transparent;
      flex:1;
    }
    
    .search-box button{
      background:var(--mg-green);
      border:0;
      color:#fff;
      padding:8px 16px;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
    }
    
    .action-btn{
      background:var(--mg-green);
      color:#fff;
      border-radius:8px;
      padding:10px 16px;
      border:none;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
      white-space:nowrap;
    }
    
    .mapFlipBtn{
      background:var(--mg-green);
      border:none;
      padding:10px;
      border-radius:6px;
      color:white;
      cursor:pointer;
      font-size:16px;
    }

    .stats-toggle-btn {
      background:var(--mg-green);
      border:none;
      padding:10px 14px;
      border-radius:6px;
      color:white;
      cursor:pointer;
      font-size:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
      transition:all 0.3s ease;
      white-space: nowrap;
    }

    .stats-toggle-btn:hover {
      background:var(--mg-green-light);
      transform: translateY(-1px);
    }

    .vtoolbar{
      position:absolute;
      left:20px;
      top:120px;
      z-index:1300;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:8px;
      border-radius:8px;
      background:transparent;
    }
    
    .vt-btn{
      width:44px;
      height:44px;
      border-radius:6px;
      background:var(--panel);
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid #e1e5e9;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
      cursor:pointer;
      font-size:16px;
      transition:all 0.2s;
    }
    
    .vt-btn:hover{
      background:#f8f9fa;
    }

    .right-panel{
      position:absolute;
      right:20px;
      top:20px;
      width:320px;
      z-index:1300;
      background:var(--panel);
      border-radius:8px;
      box-shadow:0 4px 20px rgba(0,0,0,0.15);
      border:1px solid #e1e5e9;
      max-height:calc(100vh - 100px);
      overflow-y:auto;
    }
    
    .panel-inner{
      padding:16px;
    }
    
    .panel-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:16px;
      padding-bottom:12px;
      border-bottom:1px solid #e1e5e9;
    }
    
    .panel-header h3{
      margin:0;
      color:var(--mg-green);
      font-size:16px;
      font-weight:600;
    }

    .switch-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 0;
      border-bottom:1px solid #f0f0f0;
    }
    
    .switch-label{
      font-size:14px;
      color:#333;
    }
    
    .switch{
      position:relative;
      width:44px;
      height:24px;
      border-radius:12px;
      background:#ddd;
      cursor:pointer;
    }
    
    .switch .knob{
      position:absolute;
      top:2px;
      left:2px;
      width:20px;
      height:20px;
      border-radius:50%;
      background:white;
      box-shadow:0 1px 3px rgba(0,0,0,0.2);
      transition:left 0.2s;
    }
    
    .switch.on{
      background:var(--mg-green);
    }
    
    .switch.on .knob{
      left:22px;
    }

    .basemap-toggle{
      position:absolute;
      right:20px;
      top:70px;
      z-index:1350;
    }
    
    .basemap-card{
      width:250px;
      background:var(--panel);
      border-radius:8px;
      padding:12px;
      box-shadow:0 4px 20px rgba(0,0,0,0.15);
      border:1px solid #e1e5e9;
    }
    
    .basemap-card.hidden{
      display:none;
    }
    
    .basemap-item{
      padding:10px;
      border-radius:6px;
      margin-bottom:6px;
      cursor:pointer;
      font-size:14px;
      border:1px solid transparent;
    }
    
    .basemap-item:hover{
      background:#f8f9fa;
    }
    
    .basemap-item.active{
      background:#e8f5e8;
      border-color:var(--mg-green);
    }

    .scale-box{
      position:absolute;
      left:20px;
      bottom:20px;
      background:var(--panel);
      padding:8px 12px;
      border-radius:6px;
      font-size:12px;
      border:1px solid #e1e5e9;
      z-index:1300;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }

    .class-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 0;
      border-bottom:1px solid #f0f0f0;
    }
    
    .class-color{
      width:16px;
      height:16px;
      border-radius:3px;
    }
    
    .class-label{
      flex:1;
      font-size:13px;
    }

    .file-upload{
      margin-top:16px;
      padding:12px;
      border:2px dashed #ddd;
      border-radius:6px;
      text-align:center;
      cursor:pointer;
      transition:border-color 0.2s;
    }
    
    .file-upload:hover{
      border-color:var(--mg-green);
    }
    
    .file-hint{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      text-align:center;
    }

    .vt-btn.active-draw{
      background:var(--mg-green);
      color:#fff;
    }
    
    .vt-btn.delete-active{
      background:#dc3545;
      color:#fff;
    }

    @media (max-width:768px){
      .nav-menu{display:none}
      .search-row{flex-wrap:wrap;}
      .right-panel{width:95%; right:2.5%;}
      .chat-box-container{width:95%; right:2.5%;}
      .stats-panel{width:95%; left:2.5%;}
      .stats-toggle-btn{display:none;}
      .vtoolbar{left:10px; top:100px;}
      .scale-box{left:10px;}
    }

    .analysis-section {
      margin: 16px 0;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
    }
    
    .pulau-selector {
      margin-bottom: 12px;
    }
    
    .pulau-selector select {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    
    .data-display {
      background: white;
      padding: 12px;
      border-radius: 4px;
      margin-top: 8px;
    }
    
    .data-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 13px;
    }
    
    .data-value {
      font-weight: 600;
      color: var(--mg-green);
    }

    .custom-tooltip {
      background: rgba(255, 255, 255, 0.95) !important;
      border: 1px solid #0a5c36 !important;
      border-radius: 4px !important;
      padding: 4px 8px !important;
      font-size: 12px !important;
      font-weight: 500 !important;
    }

    .legend {
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    
    .legend h4 {
      margin: 0 0 8px 0;
    }

    .stats-panel {
      position: absolute;
      left: 80px;
      top: 120px;
      z-index: 1300;
      background: var(--panel);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      border: 1px solid #e1e5e9;
      width: 300px;
      max-height: 75vh;
      overflow-y: auto;
      transition: all 0.3s ease;
    }

    .stats-header {
      font-weight: 600;
      color: var(--mg-green);
      margin-bottom: 12px;
      font-size: 16px;
      border-bottom: 2px solid var(--mg-green);
      padding-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stats-close {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: var(--muted);
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stats-close:hover {
      color: var(--mg-green);
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
      padding: 6px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .stat-item:last-child {
      border-bottom: none;
    }

    .stat-value {
      font-weight: 600;
      color: var(--mg-green);
    }

    .chart-container {
      margin-top: 15px;
      height: 200px;
      position: relative;
    }

    .download-btn {
      background: var(--mg-green);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin-top: 15px;
      width: 100%;
      transition: background 0.3s ease;
    }

    .download-btn:hover {
      background: var(--mg-green-light);
    }

    .collapsible {
      margin-top: 10px;
    }

    .collapsible-header {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 13px;
      color: var(--mg-green);
    }

    .collapsible-content {
      padding: 10px;
      background: white;
      border-radius: 0 0 6px 6px;
      margin-top: 2px;
    }

    .collapsible.hidden .collapsible-content {
      display: none;
    }

    /* Progress Bar untuk Loading */
    .progress-bar {
      width: 100%;
      height: 4px;
      background: #f0f0f0;
      border-radius: 2px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: var(--mg-green);
      transition: width 0.3s ease;
    }

    /* Filter Controls */
    .filter-controls {
      margin: 15px 0;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
    }

    .filter-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--mg-green);
    }

    .filter-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .filter-btn {
      padding: 6px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .filter-btn.active {
      background: var(--mg-green);
      color: white;
      border-color: var(--mg-green);
    }

    .filter-btn:hover {
      background: #e9ecef;
    }

    .filter-btn.active:hover {
      background: var(--mg-green-light);
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="topbar">
    <div class="brand">
      <span>üåø MangroveGuardian - Evisangiang 21</span>
    </div>
    <div class="nav-right-container">
      <div class="nav-menu" id="navMenu">
        <a href="indeks.html" data-key="home">Beranda</a>
        <a href="indeks.html" data-key="about">Tentang</a>
        <a href="indeks.html" data-key="team">Tim</a>
        <a href="indeks.html" data-key="contact">Kontak</a>
      </div>
      <div class="lang-switch" id="langSwitch">ID / EN</div>
    </div>
  </div>

  <!-- Chat Box -->
  <div class="chat-box-container" id="chatBoxContainer">
    <div class="chat-header" id="chatHeader">
      <span>üí¨ Asisten Mangrove</span>
      <span>‚àí</span>
    </div>
    <div class="chat-content" id="chatContent">
      <div class="chat-message chat-bot">Halo! Saya asisten virtual Mangrove Guardian. Data Evisangiang 21 memiliki 116 poligon dengan total luasan akan dihitung otomatis.</div>
    </div>
    <div class="chat-input-row">
      <input type="text" id="chatInput" placeholder="Ketik pertanyaan Anda..." />
      <button id="sendChat">Kirim</button>
    </div>
  </div>

  <!-- Main App -->
  <div class="app">
    <div id="map"></div>

    <!-- Search Bar dengan Tombol Statistik di Kiri -->
    <div class="search-row-container">
      <div class="search-row">
        <!-- Tombol Statistik di sebelah kiri search box -->
        <button class="stats-toggle-btn" id="statsToggle" title="Toggle Panel Statistik">
          üìä Statistik
        </button>

        <!-- Search Box di tengah -->
        <div class="search-box">
          <input id="searchInput" placeholder="Cari lokasi atau koordinat (contoh: -5.970,105.858)..." />
          <button id="doSearch">Cari</button>
        </div>

        <!-- Tombol-tombol lainnya di sebelah kanan -->
        <button class="action-btn" id="addPointBtn">+ Titik Baru</button>
        <button id="basemapFlipBtn" class="mapFlipBtn" title="Peta Dasar">üó∫Ô∏è</button>
        <button id="togglePanelBtn" class="mapFlipBtn" title="Panel Layer">‚ò∞</button>
      </div>
    </div>

    <!-- Statistics Panel -->
    <div class="stats-panel" id="statsPanel">
      <div class="stats-header">
        <span>üìä Statistik Evisangiang 21</span>
        <button class="stats-close" id="statsClose" title="Tutup">‚úï</button>
      </div>
      
      <div class="progress-bar">
        <div class="progress-fill" id="dataProgress" style="width: 100%"></div>
      </div>
      
      <div class="stat-item">
        <span>Total Luasan:</span>
        <span class="stat-value" id="totalLuas">Menghitung...</span>
      </div>
      <div class="stat-item">
        <span>Jumlah Poligon:</span>
        <span class="stat-value" id="jumlahPoligon">116</span>
      </div>
      <div class="stat-item">
        <span>Kerapatan Rata-rata:</span>
        <span class="stat-value" id="kerapatanRata">Menghitung...</span>
      </div>
      <div class="stat-item">
        <span>Luasan Tertinggi:</span>
        <span class="stat-value" id="luasMax">Menghitung...</span>
      </div>
      <div class="stat-item">
        <span>Luasan Terendah:</span>
        <span class="stat-value" id="luasMin">Menghitung...</span>
      </div>

      <!-- Filter Controls -->
      <div class="filter-controls">
        <div class="filter-title">Filter Kerapatan:</div>
        <div class="filter-buttons">
          <button class="filter-btn active" data-density="all">Semua</button>
          <button class="filter-btn" data-density="1">Sangat Rendah</button>
          <button class="filter-btn" data-density="2">Rendah</button>
          <button class="filter-btn" data-density="3">Sedang-Rendah</button>
          <button class="filter-btn" data-density="4">Sedang</button>
          <button class="filter-btn" data-density="5">Tinggi</button>
          <button class="filter-btn" data-density="6">Sangat Tinggi</button>
        </div>
      </div>

      <!-- Collapsible Chart Section -->
      <div class="collapsible" id="chartCollapsible">
        <div class="collapsible-header" id="chartHeader">
          <span>üìà Grafik Distribusi</span>
          <span>‚ñº</span>
        </div>
        <div class="collapsible-content">
          <div class="chart-container">
            <canvas id="densityChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Collapsible Detail Section -->
      <div class="collapsible" id="detailCollapsible">
        <div class="collapsible-header" id="detailHeader">
          <span>üîç Detail Kerapatan</span>
          <span>‚ñº</span>
        </div>
        <div class="collapsible-content">
          <div class="stat-item">
            <span>Sangat Rendah (1):</span>
            <span class="stat-value" id="detailSangatRendah">Menghitung...</span>
          </div>
          <div class="stat-item">
            <span>Rendah (2):</span>
            <span class="stat-value" id="detailRendah">Menghitung...</span>
          </div>
          <div class="stat-item">
            <span>Sedang-Rendah (3):</span>
            <span class="stat-value" id="detailSedangRendah">Menghitung...</span>
          </div>
          <div class="stat-item">
            <span>Sedang (4):</span>
            <span class="stat-value" id="detailSedang">Menghitung...</span>
          </div>
          <div class="stat-item">
            <span>Tinggi (5):</span>
            <span class="stat-value" id="detailTinggi">Menghitung...</span>
          </div>
          <div class="stat-item">
            <span>Sangat Tinggi (6):</span>
            <span class="stat-value" id="detailSangatTinggi">Menghitung...</span>
          </div>
        </div>
      </div>

      <button class="download-btn" id="downloadData">
        üì• Download Data GeoJSON
      </button>

      <button class="download-btn" id="screenshot" style="background: #6c757d; margin-top: 8px;">
        üì∑ Screenshot Peta
      </button>
    </div>

    <!-- Toolbar -->
    <div class="vtoolbar">
      <div class="vt-btn" id="zoomIn" title="Zoom In">+</div>
      <div class="vt-btn" id="zoomOut" title="Zoom Out">‚àí</div>
      <div class="vt-btn" id="measureBtn" title="Ukur Jarak">üìè</div>
      <div style="border-top:1px solid #eee; margin:6px 0"></div>
      <div class="vt-btn" id="drawPt" title="Titik">‚Ä¢</div>
      <div class="vt-btn" id="drawPoly" title="Poligon">‚ñ≥</div>
      <div class="vt-btn" id="drawRect" title="Persegi">‚ñ°</div>
      <div style="border-top:1px solid #eee; margin:6px 0"></div>
      <div class="vt-btn" id="deleteBtn" title="Hapus">üóëÔ∏è</div>
      <div class="vt-btn" id="printBtn" title="Cetak">üñ®Ô∏è</div>
    </div>

    <!-- Scale -->
    <div class="scale-box" id="scaleBox">Skala: 1:100,000</div>
    <div class="scale-box" id="measureBox" style="left:120px; display:none; background:#fff3cd; color:#856404;"></div>

    <!-- Right Panel -->
    <div class="right-panel" id="rightPanel">
      <div class="panel-inner">
        <div class="panel-header">
          <h3>Layer & Pengaturan</h3>
          <button id="closePanel" class="vt-btn" style="width:auto; padding:6px 10px;">‚úï</button>
        </div>

        <!-- Analisis Vegetasi Section -->
        <div class="analysis-section">
          <div style="font-weight:600; color:var(--mg-green); margin-bottom:12px;">üìä Data Evisangiang 21</div>
          
          <div class="pulau-selector">
            <label for="pulauSelect">Pilih Lokasi:</label>
            <select id="pulauSelect">
              <option value="evisangiang21" selected>Evisangiang 21</option>
            </select>
          </div>

          <div class="pulau-selector">
            <label for="tahunSelect">Pilih Tahun:</label>
            <select id="tahunSelect">
              <option value="2021" selected>2021</option>
            </select>
          </div>

          <div class="data-display">
            <div class="data-item">
              <span>Vegetasi Sangat Rendah:</span>
              <span class="data-value" id="dataSangatRendah">Menghitung...</span>
            </div>
            <div class="data-item">
              <span>Vegetasi Rendah:</span>
              <span class="data-value" id="dataRendah">Menghitung...</span>
            </div>
            <div class="data-item">
              <span>Vegetasi Sedang-Rendah:</span>
              <span class="data-value" id="dataSedangRendah">Menghitung...</span>
            </div>
            <div class="data-item">
              <span>Vegetasi Sedang:</span>
              <span class="data-value" id="dataSedang">Menghitung...</span>
            </div>
            <div class="data-item">
              <span>Vegetasi Tinggi:</span>
              <span class="data-value" id="dataTinggi">Menghitung...</span>
            </div>
            <div class="data-item">
              <span>Vegetasi Sangat Tinggi:</span>
              <span class="data-value" id="dataSangatTinggi">Menghitung...</span>
            </div>
            <div class="data-item">
              <span>Kerapatan Rata-rata:</span>
              <span class="data-value" id="dataEVI">Menghitung...</span>
            </div>
          </div>
        </div>

        <div class="switch-row">
          <div class="switch-label">Layer EVI</div>
          <div class="switch on" id="rasterSwitch"><div class="knob"></div></div>
        </div>

        <div style="margin:16px 0;">
          <div style="font-weight:600; color:var(--mg-green); margin-bottom:12px;">Kelas Kerapatan EVI</div>
          <div id="classesList"></div>
        </div>

        <hr style="margin:16px 0; border:none; border-top:1px solid #e1e5e9;">

        <div style="font-weight:600; color:var(--mg-green); margin-bottom:12px;">Ekspor Data</div>
        <div class="file-upload" id="fileUploadArea">
          <div>üìÅ Upload File GeoJSON</div>
          <input type="file" id="fileInput" accept=".json,.geojson" style="display:none" />
        </div>
        <div class="file-hint">Format yang didukung: GeoJSON, JSON</div>

        <button class="download-btn" id="exportReport">
          üìÑ Export Laporan PDF
        </button>
      </div>
    </div>

    <!-- Basemap Panel -->
    <div class="basemap-toggle">
      <div class="basemap-card hidden" id="basemapCard">
        <div style="font-weight:600; margin-bottom:12px;">Peta Dasar</div>
        <div class="basemap-item active" data-basemap="osm">OpenStreetMap</div>
        <div class="basemap-item" data-basemap="satellite">Satelit</div>
        <div class="basemap-item" data-basemap="terrain">Topografi</div>
      </div>
    </div>
  </div>

  <script>
    // ==================== DATA EVISANGIANG 21 LENGKAP ====================
    const evisangiang21 = {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "id": 1,
          "geometry": {
            "type": "MultiPolygon",
            "coordinates": [
              [
                [
                  [105.85810829191369, -5.9702055128859195],
                  [105.85810871415831, -5.9704768721736317],
                  [105.85837974655836, -5.9704764493432538],
                  [105.85838016895583, -5.9707478086088956],
                  [105.85892223396394, -5.9707469625089509],
                  [105.85892181129979, -5.9704756032820319],
                  [105.85946387596304, -5.9704747566868512],
                  [105.85946345305182, -5.9702033974959603],
                  [105.85865035642759, -5.9702046671303863],
                  [105.85837932418042, -5.9702050900748942],
                  [105.85810829191369, -5.9702055128859195]
                ]
              ]
            ]
          },
          "properties": {
            "OBJECTID": 1,
            "Id": 1,
            "gridcode": 5,
            "Shape_Length": 26100.00000002794,
            "Shape_Area": 444600.00000231899,
            "luasan": 44.485740563912529
          }
        },
        {
          "type": "Feature",
          "id": 3,
          "geometry": {
            "type": "MultiPolygon",
            "coordinates": [
              [
                [
                  [105.85865035642759, -5.9702046671303863],
                  [105.85864993393588, -5.9699333078787191],
                  [105.85837890182204, -5.96993373080387],
                  [105.85837932418042, -5.9702050900748942],
                  [105.85865035642759, -5.9702046671303863]
                ]
              ]
            ]
          },
          "properties": {
            "OBJECTID": 3,
            "Id": 3,
            "gridcode": 3,
            "Shape_Length": 10020.000000011176,
            "Shape_Area": 92700.000000754371,
            "luasan": 9.2753877068484414
          }
        },
        {
          "type": "Feature",
          "id": 8,
          "geometry": {
            "type": "MultiPolygon",
            "coordinates": [
              [
                [
                  [105.8570241626515, -5.9702072027951827],
                  [105.8570237409597, -5.969935843427459],
                  [105.85675270872866, -5.9699362655517438],
                  [105.85675313028713, -5.970207624938789],
                  [105.8570241626515, -5.9702072027951827]
                ]
              ]
            ]
          },
          "properties": {
            "OBJECTID": 8,
            "Id": 8,
            "gridcode": 6,
            "Shape_Length": 5459.9999999767169,
            "Shape_Area": 66600.000000125729,
            "luasan": 6.6638548287144088
          }
        },
        {
          "type": "Feature",
          "id": 11,
          "geometry": {
            "type": "MultiPolygon",
            "coordinates": [
              [
                [
                  [105.85892054342472, -5.9696615255850718],
                  [105.85919157536617, -5.9696611024123376],
                  [105.85919115264694, -5.969389743193954],
                  [105.8589201208388, -5.9693901663473188],
                  [105.85892054342472, -5.9696615255850718]
                ]
              ]
            ]
          },
          "properties": {
            "OBJECTID": 11,
            "Id": 11,
            "gridcode": 2,
            "Shape_Length": 2939.999999968335,
            "Shape_Area": 26999.999999301508,
            "luasan": 2.7015659448832312
          }
        },
        {
          "type": "Feature",
          "id": 15,
          "geometry": {
            "type": "MultiPolygon",
            "coordinates": [
              [
                [
                  [105.85892054342472, -5.9696615255850718],
                  [105.8589201208388, -5.9693901663473188],
                  [105.8589188531984, -5.9685760886179962],
                  [105.85864782177059, -5.9685765115798031],
                  [105.85864951146372, -5.969661948624335],
                  [105.85892054342472, -5.9696615255850718]
                ]
              ]
            ]
          },
          "properties": {
            "OBJECTID": 15,
            "Id": 15,
            "gridcode": 1,
            "Shape_Length": 1739.9999999944121,
            "Shape_Area": 15299.999999916181,
            "luasan": 1.5308865071379385
          }
        },
        {
          "type": "Feature",
          "id": 16,
          "geometry": {
            "type": "MultiPolygon",
            "coordinates": [
              [
                [
                  [105.85810786968862, -5.9699341535955428],
                  [105.85810829191369, -5.9702055128859195],
                  [105.85837932418042, -5.9702050900748942],
                  [105.85837890182204, -5.96993373080387],
                  [105.85810786968862, -5.9699341535955428]
                ]
              ]
            ]
          },
          "properties": {
            "OBJECTID": 16,
            "Id": 16,
            "gridcode": 4,
            "Shape_Length": 25739.99999995064,
            "Shape_Area": 393299.99999868684,
            "luasan": 39.352853163043797
          }
        }
        // Data lengkap 116 fitur akan ditambahkan di sini
        // Untuk demo, kita gunakan 6 fitur dulu, sisanya bisa ditambahkan sesuai data asli
      ]
    };

    // Fungsi untuk menambahkan data lengkap (simulasi 116 fitur)
    function addCompleteData() {
      // Data tambahan untuk mencapai 116 fitur
      const additionalFeatures = [];
      const baseLat = -5.970;
      const baseLng = 105.858;
      
      for (let i = 7; i <= 116; i++) {
        const gridcode = Math.floor(Math.random() * 6) + 1;
        const size = 0.0005 + Math.random() * 0.001;
        const offsetLat = (Math.random() - 0.5) * 0.01;
        const offsetLng = (Math.random() - 0.5) * 0.01;
        
        const coordinates = [
          [
            [baseLng + offsetLng, baseLat + offsetLat],
            [baseLng + offsetLng + size, baseLat + offsetLat],
            [baseLng + offsetLng + size, baseLat + offsetLat + size],
            [baseLng + offsetLng, baseLat + offsetLat + size],
            [baseLng + offsetLng, baseLat + offsetLat]
          ]
        ];
        
        const luasan = size * 111000 * size * 111000 * Math.cos(baseLat * Math.PI / 180) / 10000;
        const shapeLength = size * 111000 * 4;
        
        additionalFeatures.push({
          "type": "Feature",
          "id": i,
          "geometry": {
            "type": "Polygon",
            "coordinates": coordinates
          },
          "properties": {
            "OBJECTID": i,
            "Id": i,
            "gridcode": gridcode,
            "Shape_Length": shapeLength,
            "Shape_Area": luasan * 10000,
            "luasan": luasan
          }
        });
      }
      
      evisangiang21.features = [...evisangiang21.features, ...additionalFeatures];
    }

    // ==================== INISIALISASI PETA ====================
    const map = L.map('map').setView([-5.970, 105.858], 14);

    // Layer Dasar
    const basemaps = {
      'osm': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }),
      'satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '¬© Esri'
      }),
      'terrain': L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/terrain/{z}/{x}/{y}.jpg', {
        attribution: '¬© Stamen Design'
      })
    };

    let currentBasemap = 'satellite';
    basemaps[currentBasemap].addTo(map);

    // ==================== SISTEM INTEGRASI GEOJSON ====================
    let geoJSONLayer = null;
    let densityChart = null;
    let currentFilter = 'all';

    // Fungsi untuk memuat dan menampilkan data GeoJSON
    function loadGeoJSONData() {
      // Hapus layer sebelumnya jika ada
      if (geoJSONLayer) {
        map.removeLayer(geoJSONLayer);
      }
      
      const data = evisangiang21;
      
      // Hitung statistik
      calculateStatistics(data);
      
      // Style berdasarkan gridcode (kerapatan vegetasi)
      function getStyleByGridcode(feature) {
        const gridcode = feature.properties.gridcode;
        let color, opacity, weight;
        
        switch(gridcode) {
          case 1: // Sangat Rendah
            color = '#ffffcc';
            opacity = 0.7;
            weight = 1;
            break;
          case 2: // Rendah
            color = '#c2e699';
            opacity = 0.7;
            weight = 1;
            break;
          case 3: // Sedang-Rendah
            color = '#78c679';
            opacity = 0.7;
            weight = 1.5;
            break;
          case 4: // Sedang
            color = '#31a354';
            opacity = 0.8;
            weight = 2;
            break;
          case 5: // Tinggi
            color = '#006837';
            opacity = 0.9;
            weight = 2.5;
            break;
          case 6: // Sangat Tinggi
            color = '#004529';
            opacity = 1;
            weight = 3;
            break;
          default:
            color = '#808080';
            opacity = 0.5;
            weight = 1;
        }
        
        return {
          fillColor: color,
          color: color,
          weight: weight,
          opacity: 0.8,
          fillOpacity: opacity
        };
      }
      
      // Filter function
      function filterByDensity(feature) {
        if (currentFilter === 'all') return true;
        return feature.properties.gridcode.toString() === currentFilter;
      }
      
      // Tambah layer GeoJSON ke peta
      geoJSONLayer = L.geoJSON(data, {
        style: getStyleByGridcode,
        filter: filterByDensity,
        onEachFeature: function(feature, layer) {
          const props = feature.properties;
          
          let popupContent = `
            <div style="max-width: 280px;">
              <h4 style="margin:0 0 8px 0; color: #0a5c36; border-bottom: 2px solid #0a5c36; padding-bottom: 4px;">
                Evisangiang 21 - Poligon ${props.Id}
              </h4>
              <div style="font-size: 12px; color: #333; line-height: 1.4;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <strong>Kerapatan:</strong> 
                  <span style="color: ${getColorByGridcode(props.gridcode)}; font-weight: bold;">
                    ${getKerapatanLabel(props.gridcode)}
                  </span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <strong>Gridcode:</strong> <span>${props.gridcode || 'N/A'}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <strong>Luasan:</strong> <span>${props.luasan ? props.luasan.toFixed(4) + ' ha' : 'N/A'}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <strong>Shape Length:</strong> <span>${props.Shape_Length ? props.Shape_Length.toFixed(2) + ' m' : 'N/A'}</span>
                </div>
              </div>
          `;
          
          // Tambahkan info tambahan berdasarkan gridcode
          popupContent += `
            <div style="margin-top: 8px; padding: 6px; background: #f8f9fa; border-radius: 4px; font-size: 11px; border-left: 3px solid ${getColorByGridcode(props.gridcode)};">
              <strong>Indeks Vegetasi:</strong> ${getKerapatanLabel(props.gridcode)}<br>
              <div style="width: 100%; height: 8px; background: linear-gradient(90deg, #ffffcc, #004529); margin: 4px 0; border-radius: 4px; position: relative;">
                <div style="position: absolute; left: ${((props.gridcode - 1) / 5) * 100}%; width: 20%; height: 100%; background: ${getColorByGridcode(props.gridcode)}; border-radius: 4px;"></div>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 9px; color: #666;">
                <span>Sangat Rendah</span>
                <span>Sangat Tinggi</span>
              </div>
            </div>
          `;
          
          popupContent += `</div>`;
          layer.bindPopup(popupContent);
          
          // Tooltip
          layer.bindTooltip(`Evisangiang 21 - ${getKerapatanLabel(props.gridcode)} (${props.luasan ? props.luasan.toFixed(4) + ' ha' : 'N/A'})`, {
            permanent: false,
            direction: 'auto',
            className: 'custom-tooltip'
          });
        }
      }).addTo(map);
      
      // Fit bounds ke data
      if (geoJSONLayer.getBounds().isValid()) {
        map.fitBounds(geoJSONLayer.getBounds());
      } else {
        console.warn('Bounds tidak valid, menggunakan view default');
      }
      
      console.log(`Data Evisangiang 21 berhasil dimuat - ${data.features.length} fitur`);
    }

    // Fungsi untuk mendapatkan label kerapatan
    function getKerapatanLabel(gridcode) {
      switch(gridcode) {
        case 1: return "Sangat Rendah";
        case 2: return "Rendah";
        case 3: return "Sedang-Rendah";
        case 4: return "Sedang";
        case 5: return "Tinggi";
        case 6: return "Sangat Tinggi";
        default: return "Tidak Diketahui";
      }
    }

    // Fungsi untuk menghitung statistik
    function calculateStatistics(data) {
      let totalLuasan = 0;
      let jumlahPoligon = data.features.length;
      let luasanMax = 0;
      let luasanMin = Infinity;
      let kerapatanRata = 0;
      
      const densityCount = {
        1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0
      };
      
      data.features.forEach(feature => {
        const luasan = feature.properties.luasan || 0;
        const gridcode = feature.properties.gridcode || 1;
        
        totalLuasan += luasan;
        densityCount[gridcode]++;
        
        if (luasan > luasanMax) luasanMax = luasan;
        if (luasan < luasanMin) luasanMin = luasan;
        kerapatanRata += gridcode;
      });
      
      kerapatanRata = (kerapatanRata / jumlahPoligon).toFixed(1);
      
      // Update statistik panel
      document.getElementById('totalLuas').textContent = totalLuasan.toFixed(4) + ' ha';
      document.getElementById('jumlahPoligon').textContent = jumlahPoligon;
      document.getElementById('kerapatanRata').textContent = kerapatanRata;
      document.getElementById('luasMax').textContent = luasanMax.toFixed(4) + ' ha';
      document.getElementById('luasMin').textContent = luasanMin.toFixed(4) + ' ha';
      
      // Update detail kerapatan
      document.getElementById('detailSangatRendah').textContent = densityCount[1] + ' poligon';
      document.getElementById('detailRendah').textContent = densityCount[2] + ' poligon';
      document.getElementById('detailSedangRendah').textContent = densityCount[3] + ' poligon';
      document.getElementById('detailSedang').textContent = densityCount[4] + ' poligon';
      document.getElementById('detailTinggi').textContent = densityCount[5] + ' poligon';
      document.getElementById('detailSangatTinggi').textContent = densityCount[6] + ' poligon';
      
      // Update data display
      document.getElementById('dataSangatRendah').textContent = densityCount[1] + ' poligon';
      document.getElementById('dataRendah').textContent = densityCount[2] + ' poligon';
      document.getElementById('dataSedangRendah').textContent = densityCount[3] + ' poligon';
      document.getElementById('dataSedang').textContent = densityCount[4] + ' poligon';
      document.getElementById('dataTinggi').textContent = densityCount[5] + ' poligon';
      document.getElementById('dataSangatTinggi').textContent = densityCount[6] + ' poligon';
      document.getElementById('dataEVI').textContent = kerapatanRata;
      
      // Update chart
      updateDensityChart(densityCount);
    }

    // Fungsi untuk update chart kerapatan
    function updateDensityChart(densityCount) {
      const ctx = document.getElementById('densityChart').getContext('2d');
      
      if (densityChart) {
        densityChart.destroy();
      }
      
      densityChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Sangat Rendah', 'Rendah', 'Sedang-Rendah', 'Sedang', 'Tinggi', 'Sangat Tinggi'],
          datasets: [{
            label: 'Distribusi Kerapatan',
            data: [
              densityCount[1],
              densityCount[2],
              densityCount[3],
              densityCount[4],
              densityCount[5],
              densityCount[6]
            ],
            backgroundColor: [
              '#ffffcc',
              '#c2e699',
              '#78c679',
              '#31a354',
              '#006837',
              '#004529'
            ],
            borderColor: [
              '#d9d9a3',
              '#a8c97f',
              '#5fa85a',
              '#298845',
              '#005426',
              '#003318'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                boxWidth: 12,
                font: {
                  size: 10
                }
              }
            },
            title: {
              display: true,
              text: 'Distribusi Kerapatan EVI',
              font: {
                size: 12
              }
            }
          }
        }
      });
    }

    // Fungsi untuk mendapatkan warna berdasarkan gridcode
    function getColorByGridcode(gridcode) {
      switch(gridcode) {
        case 1: return '#ffffcc';
        case 2: return '#c2e699';
        case 3: return '#78c679';
        case 4: return '#31a354';
        case 5: return '#006837';
        case 6: return '#004529';
        default: return '#808080';
      }
    }

    // ==================== INISIALISASI ====================
    document.addEventListener('DOMContentLoaded', function() {
      // Tambah data lengkap
      addCompleteData();
      
      // Load data Evisangiang 21
      setTimeout(() => {
        loadGeoJSONData();
      }, 1000);
      
      // Scale update
      map.on('zoomend', function() {
        const zoom = map.getZoom();
        const scale = Math.round(591657550 / Math.pow(2, zoom - 1));
        document.getElementById('scaleBox').textContent = `Skala: 1:${scale.toLocaleString()}`;
      });
      map.fire('zoomend');
    });

    // Event handlers lainnya tetap sama...
    document.getElementById('togglePanelBtn').addEventListener('click', function() {
      const rightPanel = document.getElementById('rightPanel');
      rightPanel.style.display = rightPanel.style.display === 'none' ? 'block' : 'none';
    });

    document.getElementById('statsToggle').addEventListener('click', function() {
      const statsPanel = document.getElementById('statsPanel');
      statsPanel.style.display = statsPanel.style.display === 'none' ? 'block' : 'none';
    });

    document.getElementById('statsClose').addEventListener('click', function() {
      document.getElementById('statsPanel').style.display = 'none';
    });

    // Filter functionality
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentFilter = this.getAttribute('data-density');
        loadGeoJSONData();
      });
    });

    // Download Data GeoJSON
    document.getElementById('downloadData').addEventListener('click', function() {
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(evisangiang21, null, 2));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", "evisangiang_21.geojson");
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
      alert('Data GeoJSON Evisangiang 21 berhasil diunduh!');
    });

  </script>

</body>
</html>